<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Training Log</title>

<!-- PWA hooks (leave as-is; your manifest/sw can remain the same) -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#3b82f6">

<style>
/* =========================================================
   Modern Fitness App — Color System & Base Design Tokens
   (No layout/orientation changes — only visual polish)
   ========================================================= */
:root {
  /* Neutrals */
  --bg: #0e0f1a;           /* fallback; will be overridden by theme */
  --bg-2: #121326;
  --surface: #161832;
  --card: #0f1228;
  --line: rgba(255,255,255,.08);
  --text: #eaf0ff;
  --muted: #9fb1d8;

  /* Accents (will be themed) */
  --primary: #6ddcff;
  --primary-2:#7f7cff;
  --accent:  #ff5bd7;
  --success: #22c55e;
  --danger:  #ef4444;

  /* Effects */
  --radius-lg: 16px;
  --radius-md: 12px;
  --radius-sm: 10px;
  --shadow-1: 0 10px 30px rgba(0,0,0,.25);
  --shadow-2: 0 6px 18px rgba(0,0,0,.18);

  /* Sizing */
  --tap: 44px;
   
 /* ========= Safe Area ========= */
 --safe-top: 0px;  /* default for PWA + desktop browsers */
   
}

/* Light / Dark surfaces derived from accent choices */
[data-theme="light"] {
  --bg: #f7f8ff;
  --bg-2: #eef1ff;
  --surface:#ffffff;
  --card:#ffffff;
  --line:#e5e9f5;
  --text:#0d1028;
  --muted:#637190;
}
[data-theme="dark"] {
  --bg: #0b0e1a;
  --bg-2: #0e1130;
  --surface:#0f142e;
  --card:#0c1026;
  --line: rgba(255,255,255,.08);
  --text:#eaf0ff;
  --muted:#9fb1d8;
}

/* ***** Colorful Accent Themes (no layout changes) ***** */
/* Aurora (blue ⇄ coral) */
[data-accent="aurora"] {
  --primary:#0077B6;       /* deep ocean blue */
  --primary-2:#FF6B6B;     /* soft coral */
  --accent:#9B5DE5;        /* violet pop */
  --bg-gradient:
    radial-gradient(1200px 700px at 100% -100%, color-mix(in oklab, var(--primary) 20%, transparent), transparent),
    radial-gradient(1000px 600px at -20% 0%,  color-mix(in oklab, var(--primary-2) 20%, transparent), transparent),
    linear-gradient(180deg, var(--bg), var(--bg-2));
}

/* Neon Mint (mint ⇄ hot pink) */
[data-accent="mint"] {
  --primary:#06D6A0;       /* neon mint */
  --primary-2:#EF476F;     /* hot pink/red */
  --accent:#118AB2;        /* teal-blue accent */
  --bg-gradient:
    radial-gradient(1000px 600px at 100% -80%, color-mix(in oklab, var(--primary) 18%, transparent), transparent),
    radial-gradient(1000px 600px at -30% 0%,  color-mix(in oklab, var(--primary-2) 18%, transparent), transparent),
    linear-gradient(180deg, var(--bg), var(--bg-2));
}

/* Sunset (orange ⇄ royal blue) */
[data-accent="sunset"] {
  --primary:#FF6B35;       /* vivid orange */
  --primary-2:#3B82F6;     /* royal blue */
  --accent:#F15BB5;        /* playful pink */
  --bg-gradient:
    radial-gradient(1100px 650px at 100% -80%, color-mix(in oklab, var(--primary) 18%, transparent), transparent),
    radial-gradient(1000px 600px at -30% 0%,  color-mix(in oklab, var(--primary-2) 18%, transparent), transparent),
    linear-gradient(180deg, var(--bg), var(--bg-2));
}

/* Volt (lime ⇄ violet) */
[data-accent="volt"] {
  --primary:#84CC16;       /* electric lime */
  --primary-2:#7C3AED;     /* vivid violet */
  --accent:#14B8A6;        /* teal accent */
  --bg-gradient:
    radial-gradient(1100px 650px at 100% -80%, color-mix(in oklab, var(--primary) 18%, transparent), transparent),
    radial-gradient(1000px 600px at -30% 0%,  color-mix(in oklab, var(--primary-2) 18%, transparent), transparent),
    linear-gradient(180deg, var(--bg), var(--bg-2));
}

/* Crimson Heat (crimson ⇄ cyan) */
[data-accent="crimson"] {
  --primary:#F43F5E;       /* crimson */
  --primary-2:#06B6D4;     /* cyan/teal */
  --accent:#FB7185;        /* light rose */
  --bg-gradient:
    radial-gradient(1100px 650px at 100% -80%, color-mix(in oklab, var(--primary) 18%, transparent), transparent),
    radial-gradient(1000px 600px at -30% 0%,  color-mix(in oklab, var(--primary-2) 18%, transparent), transparent),
    linear-gradient(180deg, var(--bg), var(--bg-2));
}
.settings-wrap { position:absolute; right:16px; top:14px; }
.gear-btn { border-radius:50%; padding:.5rem .6rem; line-height:1; }

/* ========= Base ======== */
html,body {
  margin:0;
  color:var(--text);
  background: var(--bg-gradient, linear-gradient(180deg, var(--bg), var(--bg-2)));
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
  transition: background .35s ease, color .25s ease;

  /* ✨ update: ensure background fills the whole screen on all browsers */
  min-height: 100vh;
  min-height: 100svh; /* mobile dynamic viewport */
  min-height: 100dvh; /* modern */
}
body {
  /* ✨ update: flex container so content stretches to bottom (no black gap) */
  display: flex;
  flex-direction: column;

  /* ✨ new: safe area support for iOS/Android (Capacitor builds) */
  padding-top: var(--safe-top);
}

h1{ margin:14px 18px 2px; font-size:34px; letter-spacing:.2px; font-weight:800; }
h2{ margin:6px 0; font-weight:800; }

.wrap {
  padding: 0 16px 80px;
  /* ✨ update: take remaining height so gradient fills under sticky nav */
  flex: 1 0 auto;
  /* ✨ update: respect safe-area on iOS so no black strip at bottom */
  padding-bottom: calc(80px + env(safe-area-inset-bottom));
}

.title-wrap { position:relative; }
.menu-wrap { position:absolute; right:16px; top:14px; }
.menu-btn {
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  color: #fff; border: none; border-radius: 12px;
  padding: .5rem .75rem; box-shadow: var(--shadow-2);
}
.menu-panel {
  position:absolute; right:0; top:44px; z-index:1000;
  background:var(--card); border:1px solid var(--line);
  border-radius:14px; box-shadow:var(--shadow-1); padding:8px; min-width:190px;
}
.menu-panel button{
  width:100%; text-align:left; background:transparent; color:var(--text);
  border:1px solid transparent; border-radius:10px; padding:.6rem .7rem;
}
.menu-panel button:hover{ background: rgba(255,255,255,.06); }
.hidden{ display:none !important; }

/* Cards & chrome */
.card {
  border:1px solid var(--line);
  border-radius: var(--radius-lg);
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)) , var(--card);
  padding:12px; margin:12px 0; box-shadow: var(--shadow-1);
  backdrop-filter: blur(6px);
  transition: transform .18s ease, box-shadow .2s ease, background .25s ease;
}
.card:active { transform: translateY(1px); box-shadow: var(--shadow-2); }

button {
  cursor:pointer; user-select:none;
  font-size:1rem; font-weight:700;
  padding:.62rem .95rem; border-radius:14px; border:1px solid transparent;
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  color:#fff; box-shadow: var(--shadow-2);
  transition: transform .08s ease, filter .15s ease, box-shadow .2s ease;
}
button:active { transform: translateY(1px); filter: brightness(.96); }
button.ghost {
  background: transparent; color: var(--primary);
  border:1px solid rgba(255,255,255,.15);
  backdrop-filter: blur(3px);
}
button.icon {
  background: rgba(255,255,255,.04);
  color: var(--text);
  border:1px solid var(--line);
  padding:.48rem .58rem;
}

input,select,textarea{
  font-size:1rem; padding:.62rem .75rem;
  border:1px solid var(--line); border-radius:12px;
  background:rgba(255,255,255,.03); color:var(--text);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
  transition: border-color .15s ease, box-shadow .2s ease, background .25s ease;

  /* ✨ update: prevent squeeze/overlap in flex rows */
  min-width: 0; /* allow shrinking inside flex/grid */
}
input:focus, select:focus, textarea:focus{
  outline:none;
  border-color: color-mix(in oklab, var(--primary) 60%, white 0%);
  box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary) 25%, transparent 75%);
  background: rgba(255,255,255,.06);
}

.lbl{ font-weight:700; color: color-mix(in oklab, var(--text) 85%, var(--muted) 15%); }
.small{ font-size:.92rem; }
.muted{ color:var(--muted); }

/* Filters & headers */
.dl-filters{
  display:grid;
  grid-template-columns: auto 1fr auto 1fr;
  gap:8px; align-items:center; margin-bottom:8px;
}
/* ✨ update: stack filters cleanly on small screens (prevents overlap) */
@media (max-width: 640px){
  .dl-filters{ grid-template-columns: 1fr; }
  .dl-filters .lbl{ margin-top:6px; }
}

.dl-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--line); padding-bottom:8px; margin-bottom:8px; }
.dl-head h2{ margin:0; font-size:1.25rem; }

/* Exercise blocks */
.exercise{ border:1px solid var(--line); border-radius:16px; margin:12px 0; overflow:hidden; background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--surface); box-shadow: var(--shadow-2); }
.ex-head{
  display:grid; grid-template-columns: 1fr auto; align-items:center; gap:10px; padding:12px 14px;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
  border-bottom:1px solid var(--line);
}
.exercise.completed .ex-head{
  background: linear-gradient(180deg, color-mix(in oklab, var(--success) 20%, transparent 80%), transparent);
  border-bottom-color: color-mix(in oklab, var(--success) 35%, transparent 65%);
}
.ex-title{
  font-weight:800; line-height:1.25; min-width:0; overflow:hidden; word-break:break-word;
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
}
.ex-controls .ex-toggle{
  background: transparent; color: var(--primary); border:1px solid var(--line);
}

/* Smooth expand/collapse */
.ex-body{
  padding:10px 12px;
  max-height:0; opacity:0; overflow:hidden;
  transition: max-height .28s ease, opacity .25s ease;
}
.exercise.open .ex-body{ max-height: 2000px; opacity:1; }

/* Notes/timer row */
.notes{ margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.notes .spacer{ flex:1 1 auto; }
.notes textarea{ width:100%; min-height:64px; resize:vertical; }

/* 1RM + timer pills */
.oneRM, .timer{
  display:flex; align-items:center; gap:6px; font-size:.95rem;
  background: rgba(255,255,255,.04);
  border:1px solid var(--line);
  padding:6px 10px; border-radius:12px;
}
.oneRM .val{
  font-weight:800; padding:.2rem .5rem; border-radius:10px;
  background: linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff;
}

/* Tables */
.table-wrap{ overflow-x:hidden; -webkit-overflow-scrolling:touch; }
table{ border-collapse:collapse; width:100%; table-layout:fixed; }

td input[data-action="upd"], .cell-static{
  display:block;
  width:100%;
  font-size:16px;
  height:34px;
  line-height:34px;
  padding:0 4px;
  border-radius:8px;
  background-clip: padding-box; /* prevents fill bleeding into borders */
}


/* Keep compact sizing so 4 sets + Vol fit on iPhone */
@media (max-width: 480px){
  colgroup col.metric{ width:30px; }
  colgroup col.set{ width:34px; }
  colgroup col.volume{ width:38px; }
  thead th.setnum, thead th.sets-label, thead th.volume{ font-size:11.5px; }
}
@media (min-width: 481px){
  colgroup col.metric{ width:34px; }
  colgroup col.set{ width:36px; }
  colgroup col.volume{ width:40px; }
}

th,td{ border:1px solid var(--line); padding:6px; text-align:center; background: transparent; color: var(--text); }
th.sticky-left, td.sticky-left{ position:sticky; left:0; z-index:2; text-align:left; background: color-mix(in oklab, var(--surface) 92%, black 8%); }
thead th.sets-label{ font-weight:800; background: color-mix(in oklab, var(--primary) 15%, transparent 85%); color: var(--text); }
thead th.setnum, thead th.volume, thead th.blank-metric{ background: rgba(255,255,255,.03); }
thead th.date-metric{ font-size:12px; background: linear-gradient(135deg, var(--primary), var(--primary-2)); color:#fff; }

td input[data-action="upd"]{
  width:100%;
  text-align:center;
  border:1px solid var(--line);
  background: rgba(255,255,255,.02);
  color: inherit;
  -webkit-appearance: none;
  appearance: none;
}
input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
input[type=number]{ -moz-appearance:textfield; }

.cell-static{ width:100%; text-align:center; border:1px solid var(--line); background: rgba(255,255,255,.03); }
.vol-cell{ font-weight:800; padding:0 2px; border-radius:8px; }
.vol-good{ background: color-mix(in oklab, var(--success) 20%, transparent 80%) !important; color: #062; }
.vol-bad{ background: color-mix(in oklab, var(--danger) 20%, transparent 80%) !important; color: #611; }
.vol-neutral{ background: rgba(255,255,255,.04) !important; color: var(--text); }

.week-block{
  margin-bottom:10px;
  position: relative;     /* anchor for absolute button */
}

/* add: extra space so the bin doesn't overlap the table bottom */
.prev-session{
  padding-bottom: 40px;
}
/* Keep the bin INSIDE the previous table area */
.prev-session .table-wrap { position: relative; }

/* (optional but explicit) scope the absolute button to that area */
.prev-session .del-prev-btn { position: absolute; right: 6px; bottom: 6px; }

/* Current week card — bold clean outline */
.current-session {
  border: 3px solid var(--line);
  border-radius: 8px;
  margin: 10px 0 0;
}

/* Slim subtle section headers */
.section-header {
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--muted);
  margin: 6px 0 4px;
  padding-bottom: 2px;
  border-bottom: 1px solid var(--line);
}

/* small label above the table */
.session-vol{
  position: absolute;
  top: 6px;
  right: 10px;
  font-weight: 800;
  font-size: .95rem;
  color: var(--text);
  background: rgba(255,255,255,.06);
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 4px 8px;
}

/* move the delete button to the bottom-right */
.del-prev-btn{
  position:absolute;
  bottom:6px;             /* ⬅️ was top:6px */
  right:6px;
  background: transparent;
  border:1px solid var(--line);
  border-radius:8px;
  padding:.3rem .45rem;
  color: var(--muted);
}
.del-prev-btn:hover{
  color:#fff;
  background: color-mix(in oklab, var(--danger) 18%, transparent);
  border-color: color-mix(in oklab, var(--danger) 35%, transparent);
}
td.vol-cell-spacer {
  border: none !important;
  background: transparent !important;
  padding: 0 !important;
  height: auto;
}


/* Lists + drag */
.list{ list-style:none; margin:6px 0 0; padding:0; }
.list li{ padding:6px 0; border-top:1px dashed var(--line); display:flex; align-items:center; justify-content:space-between; gap:8px; }
.dragrow{ display:flex; align-items:center; gap:8px; padding:6px 0; border-top:1px dashed var(--line); }
.handle{ cursor:grab; user-select:none; font-size:18px; padding:0 6px; }
.dragging{ opacity:.6; }
.icon.small{ padding:.35rem .5rem; font-size:1rem; }
.icon.danger{ background: color-mix(in oklab, var(--danger) 14%, transparent 86%); color:#ffd7d7; border-color: color-mix(in oklab, var(--danger) 25%, transparent 75%); }

/* Footer nav */
nav.card.bottom-nav {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 50;
  margin-bottom: 0;
  border-top: 1px solid var(--line);
  width: 100%;
  padding-bottom: env(safe-area-inset-bottom, 12px);
}

/* Surface styles (glass vs flat) */
[data-surface="glass"] .card,
[data-surface="glass"] .menu-panel {
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px); /* added for Safari/Chrome WebKit */
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card);
  box-shadow: var(--shadow-1);
  border: 1px solid var(--line);
}

[data-surface="flat"] .card,
[data-surface="flat"] .menu-panel {
  backdrop-filter: none;
  -webkit-backdrop-filter: none; /* added for Safari/Chrome WebKit */
  background: var(--surface);
  box-shadow: none; /* more obvious change */
  border: 1px solid color-mix(in oklab, var(--line) 80%, transparent);
}
/* App modal */
.app-modal{ position:fixed; inset:0; display:flex; align-items:flex-end; justify-content:center;
  background:rgba(0,0,0,.35); z-index:9999; padding:16px; }
.app-modal.hidden{ display:none; }
.app-sheet{ width:100%; max-width:520px; background:var(--card); border:1px solid var(--line);
  border-radius:16px; box-shadow:var(--shadow-1); padding:14px; }
.app-sheet h3{ margin:0 0 8px; font-weight:800; }
.app-sheet .msg{ color:var(--text); margin-bottom:12px; }
.app-sheet input{ width:100%; margin-bottom:10px; }
.app-actions{ display:flex; gap:8px; justify-content:flex-end; }
.app-actions .secondary{ background:transparent; color:var(--text); border:1px solid var(--line); }


/* Subtle global motion */
* { scroll-behavior: smooth; box-sizing: border-box; }   /* ← add box-sizing */

   /* === Make "Sets" and "Vol" headings bigger === */
thead th.setnum{
  font-size: 1rem;
  font-weight: 600;
  text-align: center;
  font-variant-numeric: tabular-nums;
  font-feature-settings: "tnum" 1, "lnum" 1;
}
.cal-legend { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
.cal-legend .legend-item { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:8px; }
.cal-legend .swatch { width:14px; height:14px; border-radius:4px; outline:1px solid rgba(0,0,0,.2); }

.cal-popup[hidden]{ display:none; }
.cal-popup { position: fixed; inset:0; background: transparent; z-index: 40; }
.cal-pop-card { position:absolute; min-width:240px; max-width:320px; background: var(--surface); color: var(--text);
  border:1px solid var(--line); border-radius:12px; padding:12px; box-shadow: 0 12px 32px rgba(0,0,0,.35); }
.cal-pop-title { font-weight:800; margin-bottom:6px; }
.cal-pop-meta { display:grid; gap:4px; font-size:.95rem; margin-bottom:6px; }
.cal-pop-notes { font-size:.95rem; opacity:.95; white-space:pre-wrap; }
.cal-pop-close { margin-top:8px; width:100%; background: var(--accent); color:white; border:none; border-radius:8px; padding:10px 12px; font-weight:800; }

@media (max-width: 480px){
  thead th.sets-label {
    font-size: 1rem !important;
  }
}
/* ==== Colored cards (accent-aware) ==== */
.card {
  background:
    linear-gradient(135deg,
      color-mix(in oklab, var(--primary)   20%, var(--card) 93%),
      color-mix(in oklab, var(--primary-2) 20%, var(--card) 93%)
    );
  border-color: color-mix(in oklab, var(--primary) 24%, var(--line));
  box-shadow: var(--shadow-1);
}

.card:hover {
  box-shadow: 0 12px 28px rgba(0,0,0,.28);
  border-color: color-mix(in oklab, var(--primary) 34%, var(--line));
}
.card:active {
  transform: translateY(1px);
  filter: brightness(.98);
}

[data-surface="flat"] .card {
  background: color-mix(in oklab, var(--primary) 6%, var(--surface));
  border-color: color-mix(in oklab, var(--primary) 22%, var(--line));
}

[data-theme="light"] .card {
  background:
    linear-gradient(135deg,
      color-mix(in oklab, var(--primary)   5%, var(--card) 95%),
      color-mix(in oklab, var(--primary-2) 5%, var(--card) 95%)
    );
}

.card .section-title::before {
  content: "";
  display: inline-block;
  width: 6px;
  height: 14px;
  border-radius: 3px;
  margin-right: 8px;
  background: linear-gradient(180deg, var(--primary), var(--primary-2));
  vertical-align: middle;
}

.exercise:not(.completed) {
  background: color-mix(in oklab, var(--primary) 3%, var(--surface) 97%);
}
.exercise:not(.completed) .ex-head {
  border-bottom-color: color-mix(in oklab, var(--primary) 20%, var(--line));
}

</style>

<!-- iOS Home Screen Icon -->
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">

</head>
<body data-theme="dark" data-accent="aurora">
  <div class="title-wrap">
    <h1>Training Log</h1>
    <span class="settings-wrap">
      <button class="icon gear-btn" id="settingsBtn" data-action="navSettings" aria-label="Settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
          <path d="M19.14,12.94a7.07,7.07,0,0,0,.05-1,7.07,7.07,0,0,0-.05-1l2.11-1.65a.5.5,0,0,0,.12-.65l-2-3.46a.5.5,0,0,0-.61-.22l-2.49,1a6.79,6.79,0,0,0-1.73-1L14,2.81a.5.5,0,0,0-.5-.31H10.5a.5.5,0,0,0-.5.31L9.45,5.91a6.79,6.79,0,0,0-1.73,1l-2.49-1a.5.5,0,0,0-.61.22l-2,3.46a.5.5,0,0,0,.12.65L4.86,10a7.07,7.07,0,0,0-.05,1,7.07,7.07,0,0,0,.05,1L2.75,13.65a.5.5,0,0,0-.12.65l2,3.46a.5.5,0,0,0,.61.22l2.49-1a6.79,6.79,0,0,0,1.73,1l.55,3.1a.5.5,0,0,0,.5.31h3a.5.5,0,0,0,.5-.31l.55-3.1a6.79,6.79,0,0,0,1.73-1l2.49,1a.5.5,0,0,0,.61-.22l2-3.46a.5.5,0,0,0-.12-.65ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
        </svg> </button>
    </span>

  </div>

  <div class="wrap">
    <!-- Routines -->
    <section id="routinesPage" class="card hidden">
      <div class="dl-head" style="margin:0;padding-bottom:0;border:0">
        <h2>Routines</h2>
        <div class="dl-controls">

          <button id="openWizardBtn" type="button" data-action="openWizard">Create routine</button>
        </div>
      </div>

      <div id="routinesList" class="card" style="margin-top:10px">
        <div style="font-weight:800;margin-bottom:6px">Your routines</div>
        <div id="routinesListBody" class="small muted">No routines yet.</div>
      </div>

      <!-- Wizard -->
      <section id="wizard" class="card hidden" style="margin-top:10px">
        <h2>New Routine</h2>

        
        <h3 style="margin:0 0 12px; font-weight:600; font-size:1.1em; color:var(--text)">
          Start From a Template
        </h3>
        <div class="card" style="background:rgba(255,255,255,.03); border-color:var(--line); margin-top:0">
          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <select id="templateSelect" style="flex:1 1 240px">
              <option value="">Choose a template…</option>
              <option value="stronglifts">StrongLifts 5×5</option>
              <option value="startingstrength">Starting Strength</option>
              <option value="ppl">Push / Pull / Legs</option>
              <option value="upperlower">Upper / Lower 4-day</option>
              <option value="brosplit">Bro Split 5-day</option>
              <option value="fullbody3">Full Body 3-day</option>
              <option value="phul">PHUL 4-day</option>
              <option value="phat">PHAT 5-day</option>
              <option value="snowy">Snowy’s Log</option>
            </select>
            <button class="ghost" data-action="useTemplateSelected">Import</button>
          </div>
        </div>
         
               
        <!-- Separator -->
        <div style="margin: 20px 0; text-align:center; font-weight:500; color:var(--text)">
          Or
        </div>
      
        <h3 style="margin-bottom:12px; font-weight:600; font-size:1.1em; color:var(--text)">
          Create Your Own Routine
        </h3>


       <section>
         <div id="wizStep1" class="card" style="margin-top:12px">
           <div class="section-title" style="font-weight:800">1) Routine name</div>
           <input id="wizName" placeholder="e.g., Bro Split or Full Body">
           <div class="section-title" style="font-weight:800; margin-top:8px">2) How many days?</div>
           <input id="wizDaysCount" type="number" min="1" step="1" placeholder="e.g., 5">
           <div style="margin-top:8px;">
             <button type="button" data-action="wizToDays">Next: Name each day</button>
           </div>
         </div>
   
         <div id="wizStep2" class="hidden">
           <div class="section-title" style="font-weight:800">3) Name each day</div>
           <div id="wizDayNames"></div>
           <div style="margin-top:8px;">
             <button class="ghost" type="button" data-action="wizBackToCount">Back</button>
             <button type="button" data-action="wizToExercises">Next: Add exercises</button>
           </div>
         </div>
   
         <div id="wizStep3" class="hidden">
           <div class="section-title" style="font-weight:800">4) Add & order exercises per day</div>
           <div id="wizExercises"></div>
           <div style="margin-top:8px;">
             <button class="ghost" type="button" data-action="wizBackToDays">Back</button>
             <button type="button" data-action="wizFinish">Finish routine</button>
           </div>
           <div class="small muted" style="margin-top:6px">Drag the ≡ handle to reorder.</div>
         </div>
       </section>
   
       </section>
       </section>
       </section>
      

    <!-- Log -->
    <section id="logPage" class="card">
      <div class="dl-filters">
        <div class="lbl">Routine</div>
        <select id="activeRoutine"></select>
        <div class="lbl">Day</div>
        <select id="logDaySelect"></select>
      </div>

      <div class="dl-head">
        <h2>Daily Log</h2>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;"><!-- ✨ update: ensure wrap -->
          <input id="workoutDate" type="date">
          <button type="button" data-action="saveDay">Save day</button>
        </div>
      </div>

      <div id="logArea" class="muted">Create/select a routine and day.</div>
    </section>

<!-- History (Calendar + Trends) -->
<section id="historyPage" class="card hidden">
  <!-- Calendar card -->
  <div class="card">
   <div class="dl-head" style="margin:0;padding-bottom:0;border:0">
     <div class="dl-controls cal-monthbar" role="group" aria-label="Month navigation">
       <button id="cal-prev" class="icon" aria-label="Previous month" type="button">‹</button>
       <div id="cal-month-label" role="status" aria-live="polite"></div>
       <button id="cal-next" class="icon" aria-label="Next month" type="button">›</button>
     </div>
   </div>


    

    <!-- Calendar grid -->
    <div class="cal-grid" id="cal-grid" aria-label="Monthly calendar" role="grid" aria-readonly="true" style="margin-top:8px">
      <div class="cal-dow" role="columnheader" aria-label="Monday">Mon</div>
      <div class="cal-dow" role="columnheader" aria-label="Tuesday">Tue</div>
      <div class="cal-dow" role="columnheader" aria-label="Wednesday">Wed</div>
      <div class="cal-dow" role="columnheader" aria-label="Thursday">Thu</div>
      <div class="cal-dow" role="columnheader" aria-label="Friday">Fri</div>
      <div class="cal-dow" role="columnheader" aria-label="Saturday">Sat</div>
      <div class="cal-dow" role="columnheader" aria-label="Sunday">Sun</div>
      <!-- days injected here -->
    </div>
     
   <!-- Legend -->
   <div class="cal-legend" id="cal-legend" aria-label="Workout legend" style="margin-top:8px"></div>
     
    <!-- Popup -->
    <div id="cal-popup" class="cal-popup" role="dialog" aria-modal="true" hidden>
      <div class="cal-pop-card" role="document">
        <div class="cal-pop-title" id="pop-title">—</div>
        <div class="cal-pop-meta">
          <div><strong>Sets/Reps:</strong> <span id="pop-sets-reps">—</span></div>
          <div><strong>Total Volume:</strong> <span id="pop-volume">—</span></div>
        </div>
        <div class="cal-pop-notes" id="pop-notes"></div>
        <button id="pop-close" class="cal-pop-close" aria-label="Close details">Close</button>
      </div>
    </div>
  </div>

  <!-- Trends card (unchanged UI, just moved under History) -->
<div class="card" id="history-trends" style="margin-top:12px">
  <div class="dl-head" style="margin:0;padding-bottom:0;border:0">
    <h2 style="display:flex;align-items:center;gap:8px">
    <button class="icon" type="button" data-action="toggleTrendsCard" aria-expanded="true" aria-controls="trendsContent" title="Collapse / expand">▾</button>
    Trends
  </h2>
  <div class="dl-controls" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
    <label class="small">Day
      <select id="trendDaySelect"></select>
    </label>
    <label class="small">Window
      <select id="trendWeeks">
        <option value="4">Last 4</option>
        <option value="8" selected>Last 8</option>
        <option value="12">Last 12</option>
      </select>
    </label>
  </div>
</div>

<div id="trendsContent" style="margin-top:8px">
  <div id="trendsArea" class="muted">No data yet. Save a few days to see trends.</div>
</div>

  </div>
</section>


    <!-- Settings -->
    <section id="settingsPage" class="card hidden">
      <div class="dl-head" style="margin:0;padding-bottom:0;border:0">
        <h2>Settings</h2>
      </div>

<div class="card" style="margin-top:8px">
  <div style="font-weight:800; margin-bottom:6px">Appearance</div>
  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
    <button class="ghost" id="themeToggle" type="button">Toggle dark mode</button>
    
    <label>Color scheme
      <select id="accentSelect">
        <option value="aurora">Aurora (blue/purple)</option>
        <option value="mint">Neon Mint</option>
        <option value="sunset">Sunset</option>
        <option value="volt">Volt</option>
        <option value="crimson">Crimson Heat</option>
      </select>
    </label> <!-- ✅ closing label before Surface style -->

    <label>Surface style
      <select id="surfaceSelect">
        <option value="glass">Glass</option>
        <option value="flat">Flat</option>
      </select>
    </label>
  </div>
</div>

<!-- Preferences -->
<div class="card">
  <div style="font-weight:800; margin-bottom:6px">Preferences</div>

  <label class="small" style="display:flex; align-items:center; gap:6px; margin-bottom:6px;">
    <input type="checkbox" id="carryOverWeights">
    Carry over last weights to next session
  </label>

   <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
      <label>Default number of sets per exercise
        <select id="defaultSetCount">
           <option value="3">3</option>
           <option value="4" selected>4</option>
           <option value="5">5</option>
        </select>
      </label>
   </div>
        
</div>


      <div class="card">
        <div style="font-weight:800; margin-bottom:6px">Units</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <label>Weight units
            <select id="unitSelect">
              <option value="kg">kg</option>
              <option value="lb">lb</option>
            </select>
          </label>
          <label class="small" style="display:flex; align-items:center; gap:6px">
            <input type="checkbox" id="unitConvertNow"> Convert existing data when switching
          </label>
        </div>
        <div class="small muted" style="margin-top:6px">Conversion uses 1 kg = 2.20462 lb.</div>
      </div>

      
<div class="card">
  <div style="font-weight:800; margin-bottom:6px">Rest Timer</div>

  <label style="display:block; margin-bottom:4px">
    <input type="checkbox" id="autoTimerEnabled">
    Auto-start rest timer after sets (1–3)
  </label>

  <label style="display:block; margin-bottom:4px">
    <input type="checkbox" id="restAlarmEnabled">
    Play alarm when timer ends
  </label>

  <label style="display:block; margin-bottom:4px">
    Duration:
    <input type="number" id="restDurationMin" min="0.5" max="10" step="0.5" style="width:60px; text-align:center">
    minutes
  </label>

  <label style="display:block; margin-bottom:4px">
    Alarm sound:
    <select id="restSound">
      <option value="ding.mp3">Ding</option>
      <option value="beep.mp3">Beep</option>
      <option value="chime.mp3">Chime</option>
    </select>
  </label>
</div>

<div class="card">
  <div style="font-weight:800; margin-bottom:6px">Data</div>
  <div style="display:flex; flex-direction:column; gap:8px">
    <!-- Top row: Check for updates -->
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="ghost" id="checkUpdatesBtn" type="button">Check for updates</button>
    </div>

    <!-- Second row: Export + Import -->
    <div style="display:flex; gap:8px; flex-wrap:wrap">
      <button class="ghost" id="exportJsonBtn" type="button">Export Backup</button>
      <button class="ghost" id="importJsonBtn" type="button">Import Backup</button>
      <input id="importJsonInput" type="file" accept="application/json" style="display:none">
    </div>
  </div>
  <div class="small muted" style="margin-top:6px">Export a backup and restore it later.</div>
</div>

     
    </section>

<nav class="card bottom-nav">
  <div class="bottom-bar">
    <button class="ghost" type="button" data-action="navLog">Log</button>
    <button class="ghost" type="button" data-action="navRoutines">Routines</button>
    <button class="ghost" type="button" data-action="navHistory">History</button>
  </div>
</nav>

<style>
/* already fixed to bottom via your existing nav.card rule */
.bottom-nav .bottom-bar {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.bottom-nav .bottom-bar button {
  width: 100%;
}
</style>

<style>
/* other styles... */

/* Gear settings button styling */
.gear-btn {
  border-radius: 50%;
  padding: 6px;
  background: var(--accent);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-2);
  transition: transform 0.15s ease;
}
.gear-btn:hover {
  transform: scale(1.1);
}
</style>

<style>
/* ===== Calendar fixes (overrides global button styles) ===== */

.calendar-page, #historyPage .card { overflow-x: hidden; }

/* kill the global button gradient/padding/box-shadow for day cells */
.cal-day{
  padding: 0 !important;
  background: none;
  box-shadow: none !important;
}

/* keep empty-day look, but still override gradients */
.cal-day.empty{ background: var(--card) !important; }

/* keep the little hover lift but no layout shift */
.cal-day:hover{ transform: translateY(-1px); }

/* allow mixed-case letters like 'Ch', 'Co' */
.cal-day .type-letter{ text-transform: none !important; }

/* Trends collapsible caret rotate */
button[data-action="toggleTrendsCard"][aria-expanded="false"] { transform: rotate(-90deg); }

/* ===== Minimal calendar look (numbers + tiny dots) ===== */

/* Center the month nav bar */
.cal-monthbar {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}
.cal-monthbar #cal-month-label {
  min-width:auto !important;
  text-align:center;
  font-weight:800;
}

/* Calendar grid — 7 columns */
.cal-grid{
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 8px;
  max-width: 100%;
  overflow-x: hidden;
}

/* Day-of-week row stays subtle */
.cal-dow { text-align:center; font-size:.85rem; opacity:.75; padding:6px 0; }

/* Replace button tiles with clean, flat cells */
.cal-cell {
  position:relative;
  aspect-ratio: 1 / 1;
  min-height: 44px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:6px;
  border:0;           /* no boxes */
  outline:0;          /* no outlines */
  background:transparent;
  color: var(--text);
}

.cal-cell.disabled { opacity:.35; pointer-events:none; }

/* Date number */
.cal-num {
  font-weight:800;
  font-size: clamp(0.95rem, 3.2vw, 1.05rem);
  line-height:1;
}

/* Dot row under the number (supports 1+ dots if ever needed) */
.cal-dots {
  display:flex;
  gap:6px;
  min-height:10px;
}

/* The dot itself (calendar) */
.cal-dot {
  width:8px;
  height:8px;
  border-radius:50%;
  display:inline-block;
  box-shadow: 0 0 0 1px rgba(0,0,0,.25);
}

/* ===== Legend (compact, dots only, only used types) ===== */
.cal-legend {
  display:flex;
  flex-wrap:wrap;
  gap:10px 14px;
  align-items:center;
}

.cal-legend .legend-item {
  display:flex;
  align-items:center;
  gap:6px;
  padding:0;
  border:0;
  background:transparent;
}

.cal-legend .legend-dot {
  width:8px;
  height:8px;
  border-radius:50%;
  display:inline-block;
  box-shadow: 0 0 0 1px rgba(0,0,0,.25);
}

.cal-legend .legend-label {
  font-size:.92rem;
  color: var(--muted);
}

/* Kill the old square-day overrides */
.cal-day,
.cal-day.empty,
.cal-day.low-contrast { all: unset; }

</style>

<div id="modalRoot" class="app-modal hidden" aria-hidden="true">
  <div class="app-sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Notice</h3>
    <div id="modalMsg" class="msg"></div>
    <input id="modalInput" class="hidden" />
    <div class="app-actions">
      <button id="modalCancel" class="secondary" type="button">Cancel</button>
      <button id="modalOK" type="button">OK</button>
    </div>
  </div>
</div>

<!-- (Optional) Firebase scripts only if you already wired cloud backup; safe if missing) -->

<script>
/* =========================================================
   App Logic — same structure as before (no orientation changes)
   Only the 3 requested updates added.
   ========================================================= */
const LS_KEY = 'workout_logger_mobile_v13_themeOnly';
const THEME_KEY = 'workout_theme';
const PREFS_KEY = 'workout_prefs_v13';
const prefs = {
  units: 'kg',
  accent: 'aurora',
  surface: 'glass',
  carryOverWeights: true
};

const state = {
  routines: [],
  sessions: [],
  log: { dayId:null, prepared:{}, notes:{}, workoutDate:null },
  wiz: { editingId:null, name:'', daysCount:0, dayNames:[], dayExercises:{} },
  uiPrevWeeks: {},
  uiPrevWeeksAll: 1,
  uiTimers: {},   // legacy per-ex timers (left in place; no harm)
  uiTimer: {      // NEW: single shared timer
    running:false, start:0, elapsed:0, interval:null,
    alarmEnabled:false, alarmAtMs:0, alarmFired:false, soundFile:'ding.mp3'
  },
  uiOpen: {},
  trendsDayId: null,         // ⬅️ NEW: day used by History→Trends
  uiTrendsCollapsed: true   // ⬅️ NEW: collapse state
};



// --- Tiny sound engine (Web Audio) ---
// Uses fetch + decodeAudioData, so it doesn't create a media session.
// Caches buffers and works on iOS once resumed after any user gesture.
const Sound = (() => {
  let ctx = null;
  const cache = new Map();

  function getCtx() {
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    return ctx;
  }
  async function resume() {
    const c = getCtx();
    if (c.state === 'suspended') { try { await c.resume(); } catch {} }
  }
  async function loadBuffer(file) {
    if (cache.has(file)) return cache.get(file);
    const c = getCtx();
    const res = await fetch('sounds/' + file);
    const arr = await res.arrayBuffer();
    // Safari quirk: pass a copy to decodeAudioData
    const buf = await new Promise((resolve, reject) =>
      c.decodeAudioData(arr.slice(0), resolve, reject)
    );
    cache.set(file, buf);
    return buf;
  }
  async function play(file, { volume = 1.0 } = {}) {
    await resume();
    const c = getCtx();
    const buffer = await loadBuffer(file);
    const src = c.createBufferSource();
    const gain = c.createGain();
    gain.gain.value = volume;
    src.buffer = buffer;
    src.connect(gain).connect(c.destination);
    src.start(0);
    // return a promise that resolves when the sound finishes
    return new Promise(r => (src.onended = r));
  }
  return { resume, play };
})();

   
// Track the current page and the last non-settings page
let currentPage = 'logPage';
let lastNonSettingsPage = 'logPage';

/* ====== Templates & Exercise Library (unchanged) ====== */
function tStrongLifts(){ return { name:'StrongLifts', days:[ {name:'Workout A', ex:['Back Squat','Barbell Bench Press','Barbell Row']}, {name:'Workout B', ex:['Back Squat','Overhead Press','Deadlift']} ] }; }
function tStartingStrength(){ return { name:'Starting Strength', days:[ {name:'Day A', ex:['Back Squat','Barbell Bench Press','Deadlift']}, {name:'Day B', ex:['Back Squat','Overhead Press','Power Clean (or Rows)']} ] }; }
function tPPL(){ return { name:'Push / Pull / Legs', days:[ {name:'Push', ex:['Barbell Bench Press','Overhead Press','Incline Dumbbell Press','Lateral Raise','Cable Pressdown']}, {name:'Pull', ex:['Deadlift','Barbell Row','Lat Pulldown / Pull-Up','Face Pull','Barbell Curl']}, {name:'Legs', ex:['Back Squat','Romanian Deadlift','Leg Press','Leg Extension','Seated Leg Curl','Standing Calf Raise']} ] }; }
function tUpperLower(){ return { name:'Upper / Lower 4-day', days:[ {name:'Upper 1', ex:['Barbell Bench Press','Row (Barbell/Cable)','Overhead Press','Lat Pulldown / Pull-Up','Dumbbell Curl','Cable Pressdown']}, {name:'Lower 1', ex:['Back Squat','Romanian Deadlift','Leg Press','Leg Extension','Seated Leg Curl','Standing Calf Raise']}, {name:'Upper 2', ex:['Incline Bench Press','Chest-Supported Row','Dumbbell Shoulder Press','Chin-Up','Hammer Curl','Skull Crusher']}, {name:'Lower 2', ex:['Front Squat (or Back Squat)','Hip Thrust','Lying Leg Curl','Leg Extension','Seated Calf Raise']} ] }; }
function tBroSplit(){ return { name:'Bro Split 5-day', days:[ {name:'Chest', ex:['Barbell Bench Press','Incline Dumbbell Press','Dumbbell Flye','Cable Flye','Push-Up']}, {name:'Back', ex:['Deadlift','Barbell Row','Lat Pulldown','Seated Cable Row','Face Pull']}, {name:'Shoulders', ex:['Overhead Press','Dumbbell Shoulder Press','Lateral Raise','Rear Delt Flye','Front Raise']}, {name:'Legs', ex:['Back Squat','Romanian Deadlift','Leg Press','Leg Extension','Seated Leg Curl','Standing Calf Raise']}, {name:'Arms', ex:['Barbell Curl','Hammer Curl','Cable Curl','Skull Crusher','Cable Pressdown','Dip']} ] }; }
function tFullBody3(){ return { name:'Full Body 3-day', days:[ {name:'Full A', ex:['Back Squat','Barbell Bench Press','Barbell Row','Lateral Raise','Standing Calf Raise']}, {name:'Full B', ex:['Deadlift','Overhead Press','Lat Pulldown','Incline Dumbbell Press','Leg Press']}, {name:'Full C', ex:['Front Squat','Incline Bench Press','Chest-Supported Row','Hip Thrust','Hanging Leg Raise']} ] }; }
function tPHUL(){ return { name:'PHUL 4-day', days:[ {name:'Upper Power', ex:['Barbell Bench Press','Barbell Row','Overhead Press','Lat Pulldown']}, {name:'Lower Power', ex:['Back Squat','Romanian Deadlift','Leg Press','Standing Calf Raise']}, {name:'Upper Hypertrophy', ex:['Incline Dumbbell Press','Chest-Supported Row','Lateral Raise','Barbell Curl','Cable Pressdown']}, {name:'Lower Hypertrophy', ex:['Front Squat','Hip Thrust','Leg Extension','Seated Leg Curl','Seated Calf Raise']} ] }; }
function tPHAT(){ return { name:'PHAT 5-day', days:[ {name:'Upper Power', ex:['Barbell Bench Press','Barbell Row','Overhead Press']}, {name:'Lower Power', ex:['Back Squat','Deadlift','Standing Calf Raise']}, {name:'Back/Shoulders', ex:['Lat Pulldown','Chest-Supported Row','Lateral Raise','Face Pull']}, {name:'Lower Hypertrophy', ex:['Front Squat','Leg Press','Leg Extension','Seated Leg Curl','Seated Calf Raise']}, {name:'Chest/Arms', ex:['Incline Dumbbell Press','Dumbbell Flye','Barbell Curl','Cable Pressdown']} ] }; }

/* ✨ update: Snowy's Log template */
function tSnowy(){
  return {
    name: "Snowy's Log",
    days: [
      { name:'Chest', ex:[
        'Barbell Bench Press','Machine Chest Press','Machine Shoulder Press',
        'Incline Dumbbell Press','Machine Chest Fly','Overhead Rope Triceps Extension'
      ]},
      { name:'Legs', ex:[
        'Seated Leg Curl','Leg Press','Leg Press Calf Raise','Leg Extensions',
        'Hip Thrusts','Hip Adductors','Hip Abductors'
      ]},
      { name:'Back/Shoulders', ex:[
        'Upright Row','Machine Row','Close Grip Lat Pulldown','Seated Cable Row',
        'Reverse Machine Fly','Cable Lateral Raise','Dumbbell Shrugs','Hammer Curls'
      ]},
      { name:'Core', ex:['Decline Ab Crunch','Machine Crunch','Wood Chopper','Dumbbell Side Bend'] }
    ]
  };
}

const EX_LIB = {
  "Chest": ["Barbell Bench Press","Incline Barbell Bench Press","Dumbbell Bench Press","Incline Dumbbell Press","Decline Bench Press","Dumbbell Flye","Cable Flye","Push-Up","Machine Chest Press","Smith Machine Bench Press","Pec Deck","Dips (Chest)"],
  "Back": ["Deadlift","Conventional Deadlift","Sumo Deadlift","Barbell Row","Pendlay Row","Dumbbell Row","Seal Row","Chest-Supported Row","Lat Pulldown","Wide-Grip Pulldown","Close-Grip Pulldown","Pull-Up","Chin-Up","T-Bar Row","Cable Row","Seated Cable Row","Power Clean (or Rows)","Rack Pull"],
  "Shoulders": ["Overhead Press","Seated OHP","Dumbbell Shoulder Press","Arnold Press","Lateral Raise","Cable Lateral Raise","Rear Delt Flye","Face Pull","Front Raise","Machine Shoulder Press","Landmine Press"],
  "Legs – Squat": ["Back Squat","Front Squat","Goblet Squat","Hack Squat (Machine)","Smith Machine Squat","Split Squat","Bulgarian Split Squat","Leg Press","Belt Squat"],
  "Legs – Hinge": ["Romanian Deadlift","Stiff-Leg Deadlift","Good Morning","Hip Thrust","Glute Bridge","Back Extension","Kettlebell Swing"],
  "Quads/Hams": ["Leg Extension","Seated Leg Curl","Lying Leg Curl","Nordic Ham Curl","Single-Leg Curl"],
  "Glutes": ["Hip Thrust","Glute Bridge","Cable Kickback"],
  "Biceps": ["Barbell Curl","EZ-Bar Curl","Dumbbell Curl","Incline DB Curl","Hammer Curl","Cable Curl","Preacher Curl","Concentration Curl"],
  "Triceps": ["Close-Grip Bench Press","Skull Crusher","Overhead Triceps Extension","Cable Pressdown","Dip","Rope Pushdown"],
  "Calves": ["Standing Calf Raise","Seated Calf Raise","Leg Press Calf Raise"],
  "Core": ["Plank","Hanging Leg Raise","Knee Raise","Ab Wheel Rollout","Cable Woodchop","Pallof Press","Side Plank","Crunch"],
  "Other/Machine": ["Assisted Pull-Up","Machine Row","Lat Prayer","Straight-Arm Pulldown","Reverse Pec Deck"]
};

/* ===== Utilities ===== */
const $ = id => document.getElementById(id);
const qs = (sel,root=document)=> root.querySelector(sel);
const qsa = (sel,root=document)=> Array.from(root.querySelectorAll(sel));
const uid = () => Math.random().toString(36).slice(2);

/* ===== Theme / Accent ===== */
function loadPrefs(){
  try{ Object.assign(prefs, JSON.parse(localStorage.getItem(PREFS_KEY)||'{}')); }catch{}
  document.body.setAttribute('data-accent', prefs.accent || 'aurora');
  document.body.setAttribute('data-surface', prefs.surface || 'glass'); // ← add this
}
function savePrefs(){ localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); }
function applyTheme(){
  const t = localStorage.getItem(THEME_KEY) || 'dark';
  document.body.setAttribute('data-theme', t==='dark'?'dark':'light');
}
function toggleTheme(){
  const cur = document.body.getAttribute('data-theme')==='dark'?'dark':'light';
  const next = (cur==='dark'?'light':'dark');
  document.body.setAttribute('data-theme', next==='dark'?'dark':'light');
  localStorage.setItem(THEME_KEY, next);
}
function applyAccent(){
  document.body.setAttribute('data-accent', prefs.accent || 'aurora');
  document.body.setAttribute('data-surface', prefs.surface || 'glass');
}
function applySurface(){
  document.body.setAttribute('data-surface', prefs.surface || 'glass');
}

/* ===== Persist (localStorage—as before) ===== */
function load(){
  try{
    const raw = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
Object.assign(state, {
  routines: raw.routines || [],
  activeRoutineId: raw.activeRoutineId || null,
  sessions: raw.sessions || [],
  uiPrevWeeks: raw.uiPrevWeeks || {},
  uiPrevWeeksAll: (raw.uiPrevWeeksAll ?? 1),
  uiOpen: raw.uiOpen || {},
  log: { ...state.log, ...(raw.log || {}) },
  trendsDayId: raw.trendsDayId || null,                 // ⬅️
  uiTrendsCollapsed: !!raw.uiTrendsCollapsed            // ⬅️
});

// optional one-time migration: if no shared value but some per-ex values exist, pick the first
if (raw.uiPrevWeeksAll === undefined) {
  const first = Object.values(state.uiPrevWeeks)[0];
  if (first !== undefined) state.uiPrevWeeksAll = Math.max(0, Math.min(4, parseInt(first,10) || 1));
}

  }catch{}
}
function save(){
localStorage.setItem(LS_KEY, JSON.stringify({
  routines: state.routines,
  activeRoutineId: state.activeRoutineId,
  sessions: state.sessions,
  uiPrevWeeks: state.uiPrevWeeks,
  uiPrevWeeksAll: state.uiPrevWeeksAll,
  uiOpen: state.uiOpen,
  log: state.log,
  trendsDayId: state.trendsDayId,                // ⬅️
  uiTrendsCollapsed: state.uiTrendsCollapsed     // ⬅️
}));

}

/* ===== Helpers ===== */
const activeRoutine = () => state.routines.find(r=>r.id===state.activeRoutineId)||null;
const dayById = (r,id) => r?.days.find(d=>d.id===id)||null;
const exerciseById = (d,id) => d?.exercises.find(e=>e.id===id)||null;
function sessionsForExercise(exId){
  return state.sessions
    .filter(s=>s.exerciseId===exId)
    .sort((a,b)=> new Date(b.workoutDate||b.dateISO) - new Date(a.workoutDate||a.dateISO));
}
const lastNSessions = (exId,n) => sessionsForExercise(exId).slice(0,n);
function ensureFourSets(arr){
  const a = Array.isArray(arr) ? arr.slice(0,4) : [];
  while(a.length < 4) a.push({ set:a.length+1, weight:'', reps:'' });
  return a.map((s,i)=>({ set:i+1, weight:(s?.weight??''), reps:(s?.reps??'') }));
}
function isExerciseCompleted(exId){
  const arr = state.log.prepared[exId] || [];
  return arr.some(s => (parseInt(s?.reps,10) || 0) > 0);
}
const MMM = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
function fmtShortDate(s){ if(!s) return '—'; const d=new Date(s); if(isNaN(d)) return '—'; return `${d.getDate()} ${MMM[d.getMonth()]}`; }
function todayISO(){ return new Date().toISOString().slice(0,10); }

/* ===== Navigation ===== */
function showPage(which){
  // NEW: remember last non-settings page and current page
  if (which !== 'settingsPage') lastNonSettingsPage = which;
  currentPage = which;

  ['logPage','routinesPage','historyPage','settingsPage'].forEach(id=> $(id).classList.toggle('hidden', id!==which));
  if(which==='logPage'){ renderSelectors(); buildLog(); }
  if(which==='historyPage'){ renderSelectors(); renderTrendsDaySelector(); buildTrends(); }
  if(which==='routinesPage'){ renderRoutinesList(); }
  if(which==='settingsPage'){ hydrateSettingsUI(); }
}

/* ===== Routines list/manage ===== */
function renderRoutinesList(){
  const body=$('routinesListBody'); body.innerHTML='';
  if(!state.routines.length){ body.className='small muted'; body.textContent='No routines yet.'; return; }
  const ul=document.createElement('ul'); ul.className='list';
  state.routines.forEach(r=>{
    const li=document.createElement('li');
    li.innerHTML=`<div style="min-width:0; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.name}</div>
      <div style="display:flex; gap:6px">
        <button class="icon" title="Edit" aria-label="Edit" data-action="editRoutine" data-id="${r.id}">🛠️</button>
        <button class="icon" title="Rename" aria-label="Rename" data-action="renameRoutine" data-id="${r.id}">✏️</button>
        <button class="icon danger" title="Delete" aria-label="Delete" data-action="deleteRoutine" data-id="${r.id}">🗑️</button>
      </div>`;
    ul.appendChild(li);
  });
  body.appendChild(ul);
}

/* ===== Wizard ===== */
function show(el,yes){ if(!el) return; el.classList.toggle('hidden', !yes); }
function openWizard(editing=false){
  if(!editing){ state.wiz = { editingId:null, name:'', daysCount:0, dayNames:[], dayExercises:{} }; }
  show($('wizard'), true); show($('wizStep1'), !editing); show($('wizStep2'), false); show($('wizStep3'), editing);
  if(!editing){
    $('wizName').value=''; $('wizDaysCount').value=''; $('wizDayNames').innerHTML=''; $('wizExercises').innerHTML='';
    const sel=$('templateSelect'); if(sel) sel.value='';
  }else{
    $('wizName').value=state.wiz.name; $('wizDaysCount').value=state.wiz.daysCount;
    const namesWrap=$('wizDayNames'); namesWrap.innerHTML='';
    state.wiz.dayNames.forEach((n,i)=>{ const inp=document.createElement('input'); inp.value=n; inp.addEventListener('input',e=> state.wiz.dayNames[i]=e.target.value); namesWrap.appendChild(inp); });
    wizToExercises(true);
  }
}
function wizToDays(){
  const name=$('wizName').value.trim(); const count=parseInt($('wizDaysCount').value,10);
  if(!name || !count || count<1){ alert('Enter a routine name and number of days.'); return; }
  state.wiz.name=name; state.wiz.daysCount=count; state.wiz.dayNames=Array.from({length:count},()=> '');
  const c=$('wizDayNames'); c.innerHTML='';
  state.wiz.dayNames.forEach((_,i)=>{ const inp=document.createElement('input'); inp.placeholder=`Day ${i+1} name`; inp.addEventListener('input',e=> state.wiz.dayNames[i]=e.target.value); c.appendChild(inp);});
  show($('wizStep1'), false); show($('wizStep2'), true);
}
function wizBackToCount(){ show($('wizStep1'), true); show($('wizStep2'), false); }
function populateExercisePicker(dayKey,cat){ $('exPick_'+dayKey).innerHTML=(EX_LIB[cat]||[]).map(x=>`<option value="${x}">${x}</option>`).join(''); }
function wizToExercises(fromEdit=false){
  if (!fromEdit && state.wiz.dayNames.some(n=>!n.trim())){ alert('Please name every day.'); return; }
  if (!state.wiz.dayExercises) state.wiz.dayExercises = {};
  const c=$('wizExercises'); c.innerHTML='';
  state.wiz.dayNames.forEach((name,idx)=>{
    const dayKey='day_'+idx; if(!state.wiz.dayExercises[dayKey]) state.wiz.dayExercises[dayKey]=[];
    const wrap=document.createElement('div'); wrap.className='card';
    const catOptions=Object.keys(EX_LIB).map(cat=>`<option value="${cat}">${cat}</option>`).join('');
    wrap.innerHTML=`
      <div class="section-title" style="font-weight:800">${name}</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <div style="flex:1 1 180px;"><div class="small muted">Category</div><select id="exCat_${dayKey}">${catOptions}</select></div>
        <div style="flex:1 1 220px;"><div class="small muted">Exercise (from list)</div><select id="exPick_${dayKey}"></select></div>
        <div style="flex:1 1 220px;"><div class="small muted">Or custom name</div><input id="exCustom_${dayKey}" placeholder="Custom exercise"></div>
        <div style="align-self:end"><button type="button" data-action="wizAddExercise" data-daykey="${dayKey}">Add</button></div>
      </div>
      <div id="exList_${dayKey}" class="small muted">No exercises yet.</div>`;
      /* ✨ update: flex-basis added so inputs/selects wrap before overlapping */
    c.appendChild(wrap);
    populateExercisePicker(dayKey,Object.keys(EX_LIB)[0]);
    renderWizExerciseList(dayKey);
  });
  show($('wizStep2'), false); show($('wizStep3'), true);
}
function wizBackToDays(){ show($('wizStep2'), true); show($('wizStep3'), false); }
function wizAddExercise(btn){
  const dayKey=btn.dataset.daykey, cat=$('exCat_'+dayKey).value, pick=$('exPick_'+dayKey).value, custom=$('exCustom_'+dayKey).value.trim();
  const name=custom||pick; if(!name) return;
  state.wiz.dayExercises[dayKey].push({ id:uid(), name, category:cat });
  $('exCustom_'+dayKey).value=''; renderWizExerciseList(dayKey);
}
function wizRemoveExercise(btn){
  const dayKey=btn.dataset.daykey, exId=btn.dataset.exid;
  state.wiz.dayExercises[dayKey]=state.wiz.dayExercises[dayKey].filter(e=>e.id!==exId);
  renderWizExerciseList(dayKey);
}
function renderWizExerciseList(dayKey){
  const listEl=$('exList_'+dayKey), list=state.wiz.dayExercises[dayKey];
  if(!list.length){ listEl.className='small muted'; listEl.textContent='No exercises yet.'; return; }
  listEl.className=''; const holder=document.createElement('div');
  list.forEach((ex)=>{
    const row=document.createElement('div'); row.className='dragrow'; row.dataset.exid=ex.id; row.dataset.daykey=dayKey;
    row.innerHTML=`<span class="handle" title="Drag">≡</span>
      <span style="flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${ex.name}</span>
      <button class="icon danger small" title="Remove" aria-label="Remove" data-action="wizRemoveExercise" data-daykey="${dayKey}" data-exid="${ex.id}">🗑️</button>`;
    holder.appendChild(row);
  });
  listEl.innerHTML=''; listEl.appendChild(holder);
  enableReorder(holder, (ids)=> {
    const map=new Map(state.wiz.dayExercises[dayKey].map(e=>[e.id,e]));
    state.wiz.dayExercises[dayKey]=ids.map(id=> map.get(id)).filter(Boolean);
  });
}
function enableReorder(container, onChange){
  let placeholder=null;
  function pointerDown(e){
    const handle = e.target.closest('.handle'); if(!handle) return;
    const row = e.target.closest('.dragrow'); if(!row) return;
    e.preventDefault();
    const rect=container.getBoundingClientRect();
    placeholder=document.createElement('div'); placeholder.className='dragrow'; placeholder.style.height=`${row.getBoundingClientRect().height}px`; placeholder.style.border='1px dashed var(--line)'; placeholder.style.opacity='.5';
    row.classList.add('dragging');
    row.style.position='absolute'; row.style.zIndex='1000'; row.style.width=`${row.offsetWidth}px`; row.style.pointerEvents='none';
    const offsetY = (e.touches? e.touches[0].clientY : e.clientY) - row.getBoundingClientRect().top;
    container.insertBefore(placeholder, row.nextSibling);
    function moveAt(ev){
      const y = (ev.touches? ev.touches[0].clientY : ev.clientY);
      row.style.top = (y - rect.top - offsetY) + 'px';
      const all=[...container.children];
      for(const r of all){
        if(r===row||r===placeholder) continue;
        const rr=r.getBoundingClientRect(); const mid = rr.top + rr.height/2;
        if(y < mid){ container.insertBefore(placeholder, r); break; }
        if(r===all[all.length-1]) container.appendChild(placeholder);
      }
    }
    function pointerMove(ev){ moveAt(ev); }
    function pointerUp(){
      row.classList.remove('dragging'); row.style.position=''; row.style.top=''; row.style.width=''; row.style.pointerEvents='';
      container.insertBefore(row, placeholder); container.removeChild(placeholder); placeholder=null;
      const ids=[...container.querySelectorAll('.dragrow')].map(r=>r.dataset.exid);
      onChange?.(ids);
      detach();
    }
    function detach(){
      document.removeEventListener('mousemove', pointerMove);
      document.removeEventListener('touchmove', pointerMove);
      document.removeEventListener('mouseup', pointerUp);
      document.removeEventListener('touchend', pointerUp);
    }
    document.addEventListener('mousemove', pointerMove, {passive:false});
    document.addEventListener('touchmove', pointerMove, {passive:false});
    document.addEventListener('mouseup', pointerUp);
    document.addEventListener('touchend', pointerUp);
  }
  container.addEventListener('mousedown', pointerDown);
  container.addEventListener('touchstart', pointerDown, {passive:false});
}
function useTemplateSelected(){ const v=$('templateSelect').value; if(!v){ alert('Choose a template first.'); return; } useTemplate(v); }
function useTemplate(which){
  let t=null; if(which==='stronglifts') t=tStrongLifts();
  else if(which==='startingstrength') t=tStartingStrength();
  else if(which==='ppl') t=tPPL();
  else if(which==='upperlower') t=tUpperLower();
  else if(which==='brosplit') t=tBroSplit();
  else if(which==='fullbody3') t=tFullBody3();
  else if(which==='phul') t=tPHUL();
  else if(which==='phat') t=tPHAT();
  else if(which==='snowy') t=tSnowy(); /* ✨ update: Snowy's Log mapping */
  if(!t) return;
  state.wiz = { editingId:null, name:t.name, daysCount:t.days.length, dayNames:t.days.map(d=>d.name), dayExercises:{} };
  $('wizName').value=t.name; $('wizDaysCount').value=t.days.length;
  const namesWrap=$('wizDayNames'); namesWrap.innerHTML='';
  t.days.forEach((d,i)=>{ const inp=document.createElement('input'); inp.value=d.name; inp.addEventListener('input',e=> state.wiz.dayNames[i]=e.target.value); namesWrap.appendChild(inp); });
  t.days.forEach((d,idx)=>{ state.wiz.dayExercises['day_'+idx] = d.ex.map((name)=>({ id:uid(), name, category:guessCategory(name) })); });
  wizToExercises();
}
function guessCategory(name){
  const n=name.toLowerCase();
  if(n.includes('bench') && !n.includes('close-grip')) return 'Chest';
  if(n.includes('press') && (n.includes('overhead')||n.includes('shoulder'))) return 'Shoulders';
  if(n.includes('row')||n.includes('pulldown')||n.includes('pull-up')||n.includes('chin')||n.includes('seated cable')) return 'Back';
  if(n.includes('squat')||n.includes('leg press')||n.includes('belt squat')) return 'Legs – Squat';
  if(n.includes('deadlift')||n.includes('hip thrust')||n.includes('good morning')) return 'Legs – Hinge';
  if(n.includes('curl')) return 'Biceps';
  if(n.includes('trice')||n.includes('dip')||n.includes('skull')||n.includes('pressdown')||n.includes('pushdown')) return 'Triceps';
  if(n.includes('calf')) return 'Calves';
  if(n.includes('thrust')||n.includes('glute')||n.includes('kickback')) return 'Glutes';
  if(n.includes('plank')||n.includes('raise')||n.includes('rollout')||n.includes('crunch')
      || n.includes('woodchop') || n.includes('wood chop') || n.includes('woodchopper') || n.includes('wood chopper')) return 'Core'; /* ✨ update: recognise wood chopper */
  return 'Other/Machine';
}
function wizFinish(){
  const isEdit = !!state.wiz.editingId;
  const existing = isEdit ? state.routines.find(r => r.id === state.wiz.editingId) : null;
  const dayIds   = isEdit ? (state.wiz.dayIds || existing?.days.map(d=>d.id) || []) : [];

  const newRoutine = { 
    id: isEdit ? state.wiz.editingId : uid(),
    name: state.wiz.name || 'Routine',
    days: []
  };

  state.wiz.dayNames.forEach((dn, idx) => {
    const dayKey = 'day_'+idx;
    const exList = (state.wiz.dayExercises[dayKey] || []);

    // Keep old day id when editing, or create a new one if this is a new day
    const dayId = (isEdit && dayIds[idx]) ? dayIds[idx] : uid();

    // Keep each exercise’s originalId when present (renamed/reordered is fine)
    const exercises = exList.map(ex => ({
      id: (isEdit && ex.originalId) ? ex.originalId : uid(),
      name: ex.name,
      category: ex.category || guessCategory(ex.name)
    }));

    newRoutine.days.push({
      id: dayId,
      name: (dn || `Day ${idx+1}`).trim(),
      exercises
    });
  });

  if (isEdit) {
    const i = state.routines.findIndex(r => r.id === state.wiz.editingId);
    if (i >= 0) state.routines[i] = newRoutine;
    // keep same active id; nothing else to remap since IDs were preserved
    modal.alert('Routine updated.');
  } else {
    state.routines.push(newRoutine);
    state.activeRoutineId = newRoutine.id;
    modal.alert('Routine created.');
  }

  save();
  renderSelectors();
  renderRoutinesList();
  show($('wizard'), false);
}

/* ===== Selectors ===== */
function renderSelectors(){
  const rSel=$('activeRoutine'); rSel.innerHTML='';
  if(!state.routines.length){ rSel.appendChild(new Option('(No routines yet)','')); }
  else{ state.routines.forEach(r=>{ const o=new Option(r.name,r.id); if(r.id===state.activeRoutineId) o.selected=true; rSel.appendChild(o); }); }
  const a=activeRoutine(), dSel=$('logDaySelect'); dSel.innerHTML='';
  if(a){ a.days.forEach(d=> dSel.appendChild(new Option(d.name,d.id))); if(!state.log.dayId && a.days[0]) state.log.dayId=a.days[0].id; dSel.value=state.log.dayId||''; }
  const cur = state.log.workoutDate || $('workoutDate').value || todayISO();
  $('workoutDate').value = cur;
}
function renderTrendsDaySelector(){
  const sel = $('trendDaySelect');
  if (!sel) return;

  sel.innerHTML = '';

  const r = activeRoutine();
  if (!r || !r.days || !r.days.length){
    sel.appendChild(new Option('(No days)', ''));
    state.trendsDayId = null;
    return;
  }

  // If saved id not in this routine, fall back to first day
  if (!state.trendsDayId || !r.days.some(d => d.id === state.trendsDayId)) {
    state.trendsDayId = r.days[0].id;
  }

  r.days.forEach(d => {
    const opt = new Option(d.name, d.id);
    if (d.id === state.trendsDayId) opt.selected = true;
    sel.appendChild(opt);
  });
}

$('workoutDate').addEventListener('change', (e)=>{
  state.log.workoutDate = e.target.value || todayISO(); save();
});

/* ===== Tables ===== */
const headerCols = () => `<colgroup><col class="metric"><col class="set"><col class="set"><col class="set"><col class="set"><col class="volume"></colgroup>`;
function buildHeader(){
  return `${headerCols()}<thead>
    <tr><th class="sticky-left blank-metric" rowspan="2"></th><th class="sets-label" colspan="4">Sets</th><th class="volume" rowspan="2">Vol</th></tr>
    <tr><th class="setnum">1</th><th class="setnum">2</th><th class="setnum">3</th><th class="setnum">4</th></tr>
  </thead>`;
}
function buildHeaderPrev(dateText){
  return `${headerCols()}<thead>
    <tr><th class="sticky-left date-metric" rowspan="2">${dateText||''}</th><th class="sets-label" colspan="4">Sets</th><th class="volume" rowspan="2">Vol</th></tr>
    <tr><th class="setnum">1</th><th class="setnum">2</th><th class="setnum">3</th><th class="setnum">4</th></tr>
  </thead>`;
}
function buildPrevTables(exId, count){
  if (!count) return '';
  const unitLabel = (prefs.units || 'kg').toLowerCase();
  const prevSessions = lastNSessions(exId, count).reverse(); // oldest → newest
  if (!prevSessions.length) return `<div class="small muted">No previous</div>`;

  return prevSessions.map((s)=>{
    const dText = fmtShortDate(s.workoutDate || s.dateISO);

    let body = `<tbody><tr><td class="sticky-left">${unitLabel}</td>`;
    for (let i=0;i<4;i++){
      const st = s.sets[i] || { weight:'', reps:'' };
      body += `<td><div class="cell-static">${st.weight ?? ''}</div></td>`;
    }
    // Vol occupies only the kg row
    body += `<td class="vol-cell vol-neutral">${s.totalVolume ?? 0}</td></tr>`;
   
    // Reps row + empty spacer under Vol
    body += `<tr><td class="sticky-left">Reps</td>`;
    for (let i=0;i<4;i++){
      const st = s.sets[i] || { weight:'', reps:'' };
      body += `<td><div class="cell-static">${st.reps ?? ''}</div></td>`;
    }
    body += `<td class="vol-cell-spacer" aria-hidden="true"></td></tr></tbody>`;

    return `
      <div class="week-block prev-session">
        <div class="table-wrap">
          <table>${buildHeaderPrev(dText)}${body}</table>
          <button class="icon del-prev-btn"
                  title="Delete this entry"
                  aria-label="Delete this entry"
                  data-action="deleteSession"
                  data-sid="${s.id}"
                  data-exid="${exId}">🗑️</button>
        </div>
      </div>`;
  }).join('');
}


/* ===== 1RM / Timer / Volume ===== */
function epley1RM(w,r){ const W=+w||0, R=+r||0; if(W<=0||R<=0) return 0; return Math.round(W*(1+R/30)); }
function ensureTimer(){
  if (!state.uiTimer) {
    state.uiTimer = { running:false, start:0, elapsed:0, interval:null,
      alarmEnabled:false, alarmAtMs:0, alarmFired:false, soundFile:'ding.mp3' };
  }
  return state.uiTimer;
}
function fmtTime(ms){
  const s=Math.floor(ms/1000); const m=Math.floor(s/60); const ss=s%60;
  return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
function readTimerText(){
  const t=ensureTimer();
  const nowElapsed = t.running ? (t.elapsed + (Date.now()-t.start)) : t.elapsed;
  return fmtTime(nowElapsed);
}

function updateTimerDisplays(){
  const txt = readTimerText();
  qsa('.timer .time').forEach(el => { el.textContent = txt; });
}
function updateTimerButtons(){
  const running = ensureTimer().running;
  qsa('button[data-action="timerToggle"]').forEach(b => {
    b.textContent = running ? 'Pause' : 'Start';
  });
}



function timerToggle(exId){
  const t = ensureTimer();

  if (!t.running) {
    const { alarm, durationMin, sound } = getRestPrefs();
    t.alarmEnabled = !!alarm;
    t.alarmAtMs    = ((durationMin || 5) * 60) * 1000;
    t.soundFile    = sound;

    // ✅ reset any previous run before starting new
    t.elapsed = 0;
    t.alarmFired = false;

    Sound.resume?.();

    t.running = true;
    t.start   = Date.now();
    clearInterval(t.interval);
    t.interval = setInterval(()=>{
      updateTimerDisplays();

      if (t.alarmEnabled && !t.alarmFired) {
        const elapsed = t.elapsed + (Date.now() - t.start);
        if (elapsed >= t.alarmAtMs) {
          t.alarmFired = true;
          Sound.play(t.soundFile).catch(()=>{});
          try { if (navigator.vibrate) navigator.vibrate([60,40,60]); } catch {}
        }
      }
    }, 500);
  } else {
    t.running = false;
    t.elapsed += Date.now() - t.start;
    clearInterval(t.interval);
    t.interval = null;
  }

  updateTimerDisplays();
  updateTimerButtons();
}


function timerReset(exId){
  const t = ensureTimer();
  t.running=false; t.elapsed=0; t.start=0; t.alarmFired=false;
  clearInterval(t.interval); t.interval=null;
  updateTimerDisplays();
  updateTimerButtons();
}



/* ===== Log view ===== */
function buildLog(){
  const r=activeRoutine(), d=dayById(r,state.log.dayId), area=$('logArea');
  if(!r){ area.textContent='Create a routine to begin (Menu → Routines).'; return; }
  if(!d){ area.textContent='Select a day to begin.'; return; }

  d.exercises.forEach(ex=>{
    state.log.prepared[ex.id] = ensureFourSets(state.log.prepared[ex.id]||[]);
    if(state.uiPrevWeeks[ex.id]===undefined) state.uiPrevWeeks[ex.id]=1;
    if(!state.log.notes[ex.id]) state.log.notes[ex.id]='';
    if(state.uiOpen[ex.id]===undefined) state.uiOpen[ex.id]=false;
  });

  const unitLabel = (prefs.units || 'kg').toLowerCase();
  let html='';
  d.exercises.forEach(ex=>{
    const prepared=state.log.prepared[ex.id]||[];
    const vol=prepared.reduce((a,s)=>a+((+s.weight||0)*(+s.reps||0)),0);
    const last=sessionsForExercise(ex.id)[0]||null;
    const cls = last ? (vol>=last.totalVolume ? 'vol-good' : 'vol-bad') : 'vol-neutral';
    const prevCount = Math.max(0, Math.min(4, parseInt(state.uiPrevWeeksAll ?? 1, 10)));
    const openClass = state.uiOpen[ex.id] ? ' open' : '';
    const completedClass = isExerciseCompleted(ex.id) ? ' completed' : '';

    const best = prepared.reduce((b,s)=>{ const sc=(+s.weight||0)*(+s.reps||0); return sc>b.sc? {w:+s.weight||0,r:+s.reps||0,sc:sc}:b; }, {w:0,r:0,sc:0});
    const est = best.w>0 && best.r>0 ? Math.round(best.w*(1+best.r/30)) : 0;

    const topRow = `<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin:4px 0 8px;flex-wrap:wrap;"><!-- ✨ update: wrap -->
      <div style="display:flex;align-items:center;gap:8px">
        <span class="small muted">Prev weeks</span>
        <select data-action="setPrevWeeks" data-exid="${ex.id}">
          ${[0,1,2,3,4].map(n=>`<option value="${n}"${n===prevCount?' selected':''}>${n}</option>`).join('')}
        </select>
      </div>
      <div class="oneRM">Est. 1RM: <span id="rm_${ex.id}" class="val">${est || '—'}</span></div>
    </div>`;

    const prevHtml = buildPrevTables(ex.id, prevCount);

    let cur = `<div class="week-block current-session"><div class="table-wrap"><table>${buildHeader()}<tbody>`;
    cur += `<tr><td class="sticky-left">${unitLabel}</td>`;
    for(let i=0;i<4;i++){
      const val=prepared[i]?.weight??'';
      cur += `<td><input data-action="upd" data-exid="${ex.id}" data-idx="${i}" data-key="weight"
       type="text" inputmode="decimal" enterkeyhint="next" autocomplete="off"
       pattern="[0-9]*[.,]?[0-9]*" value="${val}"></td>`;
    }
    // kg row + Vol (Vol spans both rows)
    cur += `<td id="vol_${ex.id}" class="vol-cell ${cls}" rowspan="2">${vol}</td></tr>`;
   
    // reps row (no extra cell)
    cur += `<tr><td class="sticky-left">Reps</td>`;
    for(let i=0;i<4;i++){
      const val=prepared[i]?.reps??'';
      cur += `<td><input class="reps-input" data-set-index="${i}" data-action="upd" data-exid="${ex.id}" data-idx="${i}" data-key="reps"
       type="text" inputmode="numeric" enterkeyhint="next" autocomplete="off"
       pattern="[0-9]*" value="${val}"></td>`;
    }
    cur += `</tr></tbody></table></div></div>`;
   
   


    const note = state.log.notes[ex.id] || '';
    const notesRow = `
      <div class="notes">
        <button class="ghost" type="button" data-action="toggleNotes" data-exid="${ex.id}">Notes</button>
        <div class="spacer"></div>
        <div class="timer">
  <span class="time" id="t_${ex.id}">${readTimerText()}</span>
  <button class="ghost" type="button" data-action="timerToggle" data-exid="${ex.id}">
    ${ensureTimer().running ? 'Pause' : 'Start'}
  </button>
  <button class="ghost" type="button" data-action="timerReset" data-exid="${ex.id}">Reset</button>
</div>


        <div class="hidden" id="noteWrap_${ex.id}" style="flex-basis:100%; margin-top:6px;">
          <textarea data-action="noteInput" data-exid="${ex.id}" placeholder="Optional notes, cues, RPE…">${note}</textarea>
        </div>
      </div>`;

        html += `
  <div class="exercise${openClass}${completedClass}" data-exid="${ex.id}">
    <div class="ex-head">
      <div class="ex-title" title="${ex.name}">${ex.name}</div>
      <div class="ex-controls">
        <button class="ex-toggle" type="button" data-action="toggleExercise" data-exid="${ex.id}">
          ${state.uiOpen[ex.id] ? 'Collapse' : 'Expand'}
        </button>
      </div>
    </div>
    <div class="ex-body">
      ${topRow}

      <div class="section-header">Previous Weeks</div>
      ${prevHtml}

      <div class="section-header">Current Week</div>
      ${cur}

      <div class="section-header">Timer & Notes</div>
      ${notesRow}
    </div>
  </div>`;
  }); // ← closes the forEach

  area.innerHTML = html || '<div class="muted">No exercises yet for this day.</div>';
  save();
}

/* ===== Save Day ===== */
function saveDay(){
  const r=activeRoutine(), d=dayById(r,state.log.dayId); if(!d) return;
  const dateISO=new Date().toISOString();
  const workoutDate = state.log.workoutDate || $('workoutDate').value || dateISO.slice(0,10);
d.exercises.forEach(ex=>{
  const sets = ensureFourSets(state.log.prepared[ex.id]).map(s => ({
    set: s.set,
    weight: +s.weight || 0,
    reps: +s.reps || 0
  }));
  const anyReps = sets.some(s => s.reps > 0);
  if (!anyReps) return; // ⬅️ skip exercises not performed

  const totalVolume = sets.reduce((a,s)=> a + (s.weight * s.reps), 0);
  const note = state.log.notes[ex.id] || '';
  state.sessions.push({
    id: uid(), dateISO, workoutDate, routineId: r.id, dayId: d.id,
    exerciseId: ex.id, sets, totalVolume, note
  });
});

  save();
d.exercises.forEach(ex=>{
  const prev = ensureFourSets(state.log.prepared[ex.id] || []);
state.log.prepared[ex.id] = prev.map(s => ({
  set: s.set,
  weight: prefs.carryOverWeights
    ? ((s.weight === 0 || s.weight === '0') ? '0' : String(s.weight ?? ''))
    : '', // clear weights if carry-over disabled
  reps: ''
}));

  const wrap = qs(`.exercise[data-exid="${ex.id}"]`);
  if (wrap) wrap.classList.remove('completed');
});

// ✅ keep notes as-is (do NOT wipe state.log.notes)

  state.log.workoutDate = todayISO();
  $('workoutDate').value = state.log.workoutDate;
  modal.alert('Day saved for '+workoutDate+'.'); buildLog(); buildTrends(); save();

  if (typeof cloudBackupOverwrite === 'function') {
    (async ()=>{ try{
      const payload = { state, prefs, theme: document.body.getAttribute('data-theme') };
      await cloudBackupOverwrite(payload);
    }catch{} })();
  }
}

/* ===== Trends ===== */
function renderLineChart(data, labels){
  const W=600, H=120, PAD=14;
  if(!data.length) return `<div class="small muted">No data</div>`;
  const min = Math.min(...data), max = Math.max(...data), span = (max-min)||1;
  const xs = data.map((_,i)=> PAD + (i*(W-2*PAD))/Math.max(1,(data.length-1)));
  const ys = data.map(v=> H-PAD - ((v-min)/span)*(H-2*PAD));
  const path = xs.map((x,i)=> `${i===0?'M':'L'}${x.toFixed(1)},${ys[i].toFixed(1)}`).join(' ');
  const gridY = [0,.5,1].map(t=> H-PAD - t*(H-2*PAD));
  return `<div class="chart"><svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
    <style>.g{stroke:rgba(255,255,255,.15);stroke-width:1}.line{fill:none;stroke:var(--primary);stroke-width:2}.dot{fill:var(--accent)}.axis{font-size:10px;fill:var(--muted)}</style>
    ${gridY.map(y=>`<line class="g" x1="${PAD}" y1="${y}" x2="${W-PAD}" y2="${y}"/>`).join('')}
    <path class="line" d="${path}" />
    ${xs.map((x,i)=> `<circle class="dot" cx="${x.toFixed(1)}" cy="${ys[i].toFixed(1)}" r="3"/>`).join('')}
    <text class="axis" x="${PAD}" y="${H-2}" text-anchor="start">${labels[0]||''}</text>
    <text class="axis" x="${W-PAD}" y="${H-2}" text-anchor="end">${labels[labels.length-1]||''}</text>
  </svg></div>`;
}
function buildTrends(){
const a = activeRoutine();
const area = $('trendsArea');
const lbl = (s)=> fmtShortDate(s.workoutDate||s.dateISO);
if(!a){ area.textContent='Create a routine to begin.'; return; }
const N = parseInt($('trendWeeks').value,10) || 8;

// Prefer the History selector; fall back to Log if needed; else first
let day = null;
if (state.trendsDayId) day = dayById(a, state.trendsDayId);
if (!day && state.log.dayId) day = dayById(a, state.log.dayId);
if (!day) day = a.days[0];

if (!day){ area.textContent='No days in routine.'; return; }

  if(!day){ area.textContent='No days in routine.'; return; }
  let html='';
  day.exercises.forEach(ex=>{
    const s = sessionsForExercise(ex.id).slice(0,N).reverse();
    if(!s.length){
      html += `<div class="card chart-card" style="margin:8px 0"><div class="hdr"><div style="font-weight:800">${ex.name}</div><div class="small muted">No data yet</div></div></div>`;
      return;
    }
    const vols = s.map(x=> x.totalVolume||0);
    const lbls = s.map(lbl);
    const chart = renderLineChart(vols, lbls);
    const maxV = Math.max(...vols);
    const lastV = vols[vols.length-1];
    const change = vols.length>1 ? (lastV - vols[vols.length-2]) : 0;
    const changeTxt = (change>0? '▲ +' : (change<0? '▼ ' : '— ')) + change;
    html += `<div class="card chart-card" style="margin:8px 0">
      <div class="hdr"><div style="font-weight:800">${ex.name}</div>
      <div class="small muted">Last: <strong>${lastV}</strong> &nbsp; Max: <strong>${maxV}</strong> &nbsp; ${changeTxt}</div></div>
      ${chart}</div>`;
  });
  area.innerHTML = html || '<div class="muted">No data yet.</div>';
}

/* ===== Settings ===== */

function getRestPrefs(){
  // read minutes (float), default 5.0
  const minutes = parseFloat(localStorage.getItem('restDurationMin') || '5');
  return {
    auto:  localStorage.getItem('autoTimerEnabled') === 'true',
    alarm: localStorage.getItem('restAlarmEnabled') === 'true',
    durationMin: isNaN(minutes) ? 5 : minutes,
    sound: localStorage.getItem('restSound') || 'ding.mp3'
  };
}

function hydrateRestTimerSettings(){
  // migration from old seconds key if needed
  const hasMin = localStorage.getItem('restDurationMin') !== null;
  const oldSecs = localStorage.getItem('restDuration');
  if (!hasMin && oldSecs !== null) {
    const m = Math.max(0.5, Math.min(10, (parseInt(oldSecs,10) || 300) / 60));
    localStorage.setItem('restDurationMin', String(m));
    // optional: remove old key to avoid confusion
    // localStorage.removeItem('restDuration');
  }

  const auto   = localStorage.getItem('autoTimerEnabled') === 'true';
  const alarm  = localStorage.getItem('restAlarmEnabled') === 'true';
  const mins   = parseFloat(localStorage.getItem('restDurationMin') || '5');
  const sound  = localStorage.getItem('restSound') || 'ding.mp3';

  $('autoTimerEnabled').checked = auto;
  $('restAlarmEnabled').checked = alarm;
  $('restDurationMin').value = (isNaN(mins) ? 5 : mins);
  $('restSound').value = sound;
}
   
function hydrateSettingsUI(){
  $('unitSelect').value = prefs.units;
  $('accentSelect').value = prefs.accent;
  const ss = $('surfaceSelect'); if (ss) ss.value = prefs.surface || 'glass'; // ← add
  hydrateRestTimerSettings();
}
const KG_TO_LB = 2.20462;
function convertNumber(n, factor){ const x = (parseFloat(n)||0)*factor; return Math.round(x*100)/100; }
function convertAllWeights(factor){
  for(const exId in state.log.prepared){ (state.log.prepared[exId]||[]).forEach(s=>{ if(s.weight!=='' && !isNaN(+s.weight)) s.weight = convertNumber(s.weight, factor); }); }
  state.sessions.forEach(sess=>{
    (sess.sets||[]).forEach(s=>{ if(!isNaN(+s.weight)) s.weight = convertNumber(s.weight, factor); });
    sess.totalVolume = (sess.sets||[]).reduce((a,s)=> a + ((+s.weight||0)*(+s.reps||0)), 0);
  });
  save();
}
/* Simple promise-based modal API */
const modal = (() => {
  const root=$('modalRoot'), title=$('modalTitle'), msg=$('modalMsg');
  const inp=$('modalInput'), ok=$('modalOK'), cancel=$('modalCancel');
  let resolver=null, mode='alert';

  function open({kind='alert', heading='Notice', text='', withInput=false, def=''}) {
    mode=kind; title.textContent=heading; msg.textContent=text;
    if(withInput){ inp.classList.remove('hidden'); inp.value=def; setTimeout(()=>inp.focus(),0); }
    else{ inp.classList.add('hidden'); }
    root.classList.remove('hidden'); root.setAttribute('aria-hidden','false');
    return new Promise(res=>{ resolver=res; });
  }
  function close(val){ root.classList.add('hidden'); root.setAttribute('aria-hidden','true'); resolver?.(val); resolver=null; }

  ok.onclick = () => {
    if(mode==='prompt') close(inp.value);
    else if(mode==='confirm') close(true);
    else close(true);
  };
  cancel.onclick = () => { close(mode==='prompt' ? null : false); };
  root.addEventListener('click', (e)=>{ if(e.target===root) close(mode==='prompt'? null : false); });

  return {
    alert: (text, heading='Notice') => open({kind:'alert', heading, text}).then(()=>{}),
    confirm: (text, heading='Confirm') => open({kind:'confirm', heading, text}),
    prompt: (text, def='', heading='Input') => open({kind:'prompt', heading, text, withInput:true, def})
  };
})();

/* ===== Manual refresh / update (robust) ===== */
async function checkForUpdatesAndRefresh() {
  try {
    await modal.alert('Checking for updates…');

    if ('serviceWorker' in navigator) {
      const reg = await navigator.serviceWorker.getRegistration();

      // Listen once: when a new SW takes control, reload to pull fresh files
      let reloaded = false;
      const onControllerChange = () => {
        if (reloaded) return;
        reloaded = true;
        setTimeout(() => {
          // cache-busting query helps when a proxy/CDN is in the way
          const url = new URL(window.location.href);
          url.searchParams.set('refresh', Date.now().toString());
          window.location.href = url.toString();
        }, 150);
      };
      navigator.serviceWorker.addEventListener('controllerchange', onControllerChange, { once: true });

      if (reg) {
        // 1) Ask the SW to check for a new version now
        await reg.update().catch(()=>{});

        // 2) If a worker is already waiting, activate it immediately
        if (reg.waiting) {
          reg.waiting.postMessage({ action: 'skipWaiting' });
          await modal.alert('Update found. Applying…');
          return; // controllerchange listener above will reload
        }

        // 3) If an update is installing right now, wait for it to become waiting, then activate
        if (reg.installing) {
          await new Promise(resolve => {
            reg.installing.addEventListener('statechange', () => {
              if (reg.waiting) resolve();
            });
          });
          reg.waiting?.postMessage({ action: 'skipWaiting' });
          await modal.alert('Update found. Applying…');
          return;
        }

        // 4) No waiting or installing worker = likely no update available
        await modal.alert('No update available. Reloading…');
      }
    }

    // Fallback: normal reload (also catches the no-service-worker case)
    const url = new URL(window.location.href);
    url.searchParams.set('refresh', Date.now().toString());
    window.location.href = url.toString();
  } catch (err) {
    await modal.alert('Could not check updates. Reloading…');
    const url = new URL(window.location.href);
    url.searchParams.set('refresh', Date.now().toString());
    window.location.href = url.toString();
  }
}
// =========================================================
// Carry-over helper — fills or clears weights from last session
// =========================================================
function backfillCarryOverForCurrentDay() {
  const r = activeRoutine();
  const d = dayById(r, state.log.dayId);
  if (!d) return;

  const carryOn = prefs.carryOverWeights; // current setting state

  d.exercises.forEach(ex => {
    const prepared = ensureFourSets(state.log.prepared[ex.id] || []);
    const last = sessionsForExercise(ex.id)?.[0]; // most recent session
    const lastSets = last ? ensureFourSets(last.sets || []) : [];

    const updated = prepared.map((s, i) => {
      const repsBlank = !s.reps || s.reps.toString().trim() === '';

      // If setting is ON → fill blanks from last session
      if (carryOn) {
        return {
          set: s.set ?? (i + 1),
          weight:
            (s.weight === '' || s.weight === null || s.weight === undefined)
              ? (lastSets[i]?.weight ?? '')
              : s.weight,
          reps: s.reps ?? ''
        };
      }
      // If setting is OFF → clear weights only where reps are blank
      else {
        return {
          set: s.set ?? (i + 1),
          weight: repsBlank ? '' : s.weight,
          reps: s.reps ?? ''
        };
      }
    });

    state.log.prepared[ex.id] = updated;
  });

  save();
}

/* ===== Events ===== */
document.addEventListener('click', async (e)=>{
  const btn=e.target.closest('[data-action]'); if(!btn) return;
  const act=btn.dataset.action;
  if (act === 'toggleTrendsCard') {
  const content = $('trendsContent');
  const isOpen = content && content.style.display !== 'none';
  if (content) content.style.display = isOpen ? 'none' : '';
  btn.setAttribute('aria-expanded', String(!isOpen));
  state.uiTrendsCollapsed = isOpen;
  save();
  return;
}

  if(act==='navLog'){ showPage('logPage'); return; }
  if(act==='navRoutines'){ showPage('routinesPage'); return; }
  if(act==='navHistory'){ showPage('historyPage'); return; }
  if (act === 'navSettings') {
  if (currentPage === 'settingsPage') {
    // Go back to wherever the user was (Log/Routines/Trends)
    showPage(lastNonSettingsPage || 'logPage');
  } else {
    // Go into Settings
    showPage('settingsPage');
  }
  return;
}

if(act==='editRoutine'){ 
  const id=btn.dataset.id; 
  const r=state.routines.find(x=>x.id===id); 
  if(!r) return;

  state.wiz.editingId = r.id;
  state.wiz.name      = r.name;
  state.wiz.daysCount = r.days.length;
  state.wiz.dayNames  = r.days.map(d=>d.name);
  // keep each original Day ID in order
  state.wiz.dayIds    = r.days.map(d=>d.id);

  state.wiz.dayExercises = {};
  // for each exercise, keep a pointer to its originalId
  r.days.forEach((d,idx)=>{
    state.wiz.dayExercises['day_'+idx] = d.exercises.map(e=>({
      id: uid(),                          // temp id for the wizard row
      originalId: e.id,                   // ← preserve real id for saving
      name: e.name,
      category: e.category || guessCategory(e.name)
    }));
  });

  openWizard(true); 
  return; 
}

  if(act==='renameRoutine'){ const id=btn.dataset.id; const r=state.routines.find(x=>x.id===id); if(!r) return; const val = await modal.prompt('Rename routine:', r.name); if(!val) return; r.name=val.trim(); if(state.activeRoutineId===r.id) renderSelectors(); save(); renderRoutinesList(); return; }
  if(act==='deleteRoutine'){ const id=btn.dataset.id; const r=state.routines.find(x=>x.id===id); if(!r) return; if(!(await modal.confirm(`Delete routine "${r.name}"? Past logs remain in Trends.`))) return;
    state.routines = state.routines.filter(x=>x.id!==id); if(state.activeRoutineId===id) state.activeRoutineId = state.routines[0]?.id || null; save(); renderRoutinesList(); renderSelectors(); buildLog(); buildTrends(); return; }

  if(act==='openWizard') openWizard(false);
  else if(act==='wizToDays') wizToDays();
  else if(act==='wizBackToCount') wizBackToCount();
  else if(act==='wizToExercises') wizToExercises();
  else if(act==='wizBackToDays') wizBackToDays();
  else if(act==='wizAddExercise') wizAddExercise(btn);
  else if(act==='wizRemoveExercise') wizRemoveExercise(btn);
  else if(act==='wizFinish') wizFinish();
  else if(act==='useTemplateSelected') useTemplateSelected();

  else if(act==='saveDay'){ saveDay(); }
  else if(act==='toggleExercise'){
    const exId=btn.dataset.exid;
    qsa('.exercise.open').forEach(el=>{
      if(el.dataset.exid!==exId){ el.classList.remove('open'); const b=qs(`button[data-action="toggleExercise"][data-exid="${el.dataset.exid}"]`); if(b) b.textContent='Expand'; state.uiOpen[el.dataset.exid]=false; }
    });
    state.uiOpen[exId] = !state.uiOpen[exId];
    const wrap=qs(`.exercise[data-exid="${exId}"]`);
    if(wrap){ wrap.classList.toggle('open', state.uiOpen[exId]); btn.textContent=state.uiOpen[exId]?'Collapse':'Expand'; }
    save();
  }
  else if(act==='timerToggle'){ timerToggle(btn.dataset.exid); }
  else if(act==='timerReset'){ timerReset(btn.dataset.exid); }
  else if(act==='toggleNotes'){
    const exId=btn.dataset.exid; const w=$('noteWrap_'+exId);
    if(w) w.classList.toggle('hidden');
  }
  else if (act === 'deleteSession') {
    const sid = btn.dataset.sid;
    if (!(await modal.confirm('Delete this logged entry for this exercise? This cannot be undone.'))) return;
    state.sessions = state.sessions.filter(s => s.id !== sid);
    save();
    buildLog();
    buildTrends();
    modal.alert('Entry deleted.');
    return;
  }
});
  
function recalcVolume(exId){
  const prepared = ensureFourSets(state.log.prepared[exId]||[]);
  const vol = prepared.reduce((a,s)=> a + ((+s.weight||0)*(+s.reps||0)), 0);

  // update Vol pill
  const volEl = $('vol_'+exId);
  if (volEl){
    const last = sessionsForExercise(exId)[0] || null;
    volEl.textContent = vol;
    volEl.classList.remove('vol-good','vol-bad','vol-neutral');
    volEl.classList.add(last ? (vol >= (last.totalVolume||0) ? 'vol-good' : 'vol-bad') : 'vol-neutral');
  }

  // update Est. 1RM
  const best = prepared.reduce((b,s)=>{
    const sc=(+s.weight||0)*(+s.reps||0);
    return sc>b.sc ? {w:+s.weight||0, r:+s.reps||0, sc} : b;
  }, {w:0,r:0,sc:0});
  const est = best.w>0 && best.r>0 ? Math.round(best.w*(1+best.r/30)) : 0;
  const rmEl = $('rm_'+exId);
  if (rmEl) rmEl.textContent = est || '—';
}

document.addEventListener('change',(e)=>{
const id = (e.target && e.target.id) || '';
  if(e.target && e.target.id && e.target.id.startsWith('exCat_day_')){
    const dayKey=e.target.id.split('exCat_')[1]; populateExercisePicker(dayKey, e.target.value); return;
  }
const sel = e.target.closest('select[data-action="setPrevWeeks"]');
if (sel) {
  const val = Math.max(0, Math.min(4, parseInt(sel.value, 10) || 0));
  state.uiPrevWeeksAll = val;       // ⬅️ update shared value

  // keep current exercise open; leave others as they are
  const exId = sel.dataset.exid;
  if (exId) state.uiOpen[exId] = true;

  save();

  // update all dropdowns in-place so there’s no jump
  qsa('select[data-action="setPrevWeeks"]').forEach(s => { s.value = String(val); });

  // refresh the prev tables without collapsing open rows
  buildLog();
  return;
}
// Trends → Day selector (independent of Log)
if (e.target && e.target.id === 'trendDaySelect') {
  state.trendsDayId = e.target.value || null;
  save();
  buildTrends();
  return;
}

if(id==='activeRoutine'){
  state.activeRoutineId = $('activeRoutine').value || null;

  // keep per-exercise kg + notes so they carry forward
  state.log = {
    ...state.log,
    dayId: null,
    prepared: state.log.prepared || {},
    notes: state.log.notes || {},
    workoutDate: state.log.workoutDate || todayISO()
  };

  state.uiOpen = {};
  save();
  renderSelectors();
  renderTrendsDaySelector(); // ⬅️ populate Trends day options for the newly selected routine
  buildLog();
  buildTrends();
}else if(id==='logDaySelect'){

    state.log.dayId=$('logDaySelect').value||null; state.uiOpen = {}; save(); buildLog(); buildTrends();
  }else if(id==='trendWeeks'){ buildTrends(); }
});

document.addEventListener('input',(e)=>{
  const note=e.target.closest('textarea[data-action="noteInput"]');
  if(note){ state.log.notes[note.dataset.exid]=note.value; save(); return; }

  const inp=e.target.closest('input[data-action="upd"]'); if(!inp) return;
  const exId=inp.dataset.exid, idx=+inp.dataset.idx, key=inp.dataset.key;
  const r=activeRoutine(), d=dayById(r,state.log.dayId), ex=exerciseById(d,exId); if(!ex) return;
  state.log.prepared[exId] = ensureFourSets(state.log.prepared[exId]||[]);
  state.log.prepared[exId][idx][key]=inp.value;
  recalcVolume(exId);
  const wrap = qs(`.exercise[data-exid="${exId}"]`);
  if (wrap) wrap.classList.toggle('completed', isExerciseCompleted(exId));
  save();
  
// Auto-start rest when reps are entered for sets 1–3
if (key === 'reps' && getRestPrefs().auto) {
  const setIdx = parseInt(inp.dataset.setIndex || idx || '0', 10); // use dataset first
  const repsNow = parseInt(inp.value || '0', 10);

  if (setIdx < 3 && repsNow > 0) {
ensureTimer();  // shared timer
timerReset();   // reset shared
timerToggle();  // start shared


    // optional: little pulse effect to show it started
    const pill = qs(`.exercise[data-exid="${exId}"] .timer`);
    if (pill) {
      pill.classList.add('pulse');
      setTimeout(()=> pill.classList.remove('pulse'), 500);
    }
  }
}


});

document.addEventListener('keydown',(e)=>{
  const inp=e.target.closest('input[data-action="upd"]'); if(!inp) return;
  if(e.key==='Enter'){ e.preventDefault();
    const exId=inp.dataset.exid;
    const wrap = qs(`.exercise[data-exid="${exId}"]`);
    const inputs = Array.from(wrap.querySelectorAll('input[data-action="upd"]'));
    const i = inputs.indexOf(inp); const next = inputs[i+1] || inputs[0];
    next?.focus(); next?.select?.();
  }
});

$('checkUpdatesBtn')?.addEventListener('click', checkForUpdatesAndRefresh);
/* Settings */
$('themeToggle').addEventListener('click', toggleTheme);
$('accentSelect').addEventListener('change', (e)=>{ prefs.accent=e.target.value; savePrefs(); applyAccent(); });

$('surfaceSelect')?.addEventListener('change', (e)=>{
  prefs.surface = e.target.value || 'glass';
  savePrefs();
  applySurface();
});

$('unitSelect').addEventListener('change', (e)=>{
  const next = e.target.value; if(next!==prefs.units){
    const convert = $('unitConvertNow').checked;
    if(convert){
      const factor = (prefs.units==='kg' && next==='lb') ? 2.20462 : (prefs.units==='lb' && next==='kg') ? 1/2.20462 : 1;
      if(factor!==1) convertAllWeights(factor);
    }
    prefs.units = next; savePrefs(); buildLog(); buildTrends();
  }
});
   
// =========================================================
// Carry-over setting toggle
// =========================================================
$('carryOverWeights')?.addEventListener('change', (e) => {
  const on = !!e.target.checked;
  prefs.carryOverWeights = on;
  savePrefs();

  // Always call the helper now, for both on/off
  backfillCarryOverForCurrentDay();
  buildLog(); // refresh inputs to reflect new state
});


$('autoTimerEnabled')?.addEventListener('change', ()=> {
  localStorage.setItem('autoTimerEnabled', String($('autoTimerEnabled').checked));
});

$('restAlarmEnabled')?.addEventListener('change', ()=> {
  localStorage.setItem('restAlarmEnabled', String($('restAlarmEnabled').checked));
});
$('restDurationMin')?.addEventListener('change', ()=> {
  let v = parseFloat($('restDurationMin').value);
  if (isNaN(v)) v = 5;
  v = Math.max(0.5, Math.min(10, v)); // clamp 0.5–10 min
  $('restDurationMin').value = v;

  // ✅ store and sync immediately
  localStorage.setItem('restDurationMin', String(v));

  // ✅ update the running shared timer’s alarm target if active
  const t = ensureTimer?.();
  if (t) {
    t.alarmAtMs = (v * 60) * 1000;
  }
});

$('restSound')?.addEventListener('change', async () => {
  const file = $('restSound').value;
  localStorage.setItem('restSound', file);   // persist the choice

  // optional: keep the currently running timer in sync
  const t = ensureTimer?.();
  if (t) t.soundFile = file;

  // optional: preview the sound so the user hears it immediately
  try {
    await Sound.resume();
    await Sound.play(file, { volume: 1.0 });
  } catch {}
});


   
$('exportJsonBtn').addEventListener('click', ()=>{
  const blob = new Blob([ JSON.stringify({state,prefs,theme:document.body.getAttribute('data-theme')}, null, 2) ], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='workout_logger_backup.json'; a.click();
  URL.revokeObjectURL(url);
});
$('importJsonBtn')?.addEventListener('click', ()=> $('importJsonInput').click());
$('importJsonInput').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const txt = await f.text(); const obj = JSON.parse(txt);
    if(obj.state){ Object.assign(state, obj.state); save(); }
    if(obj.prefs){ Object.assign(prefs, obj.prefs); savePrefs(); }
    if(obj.theme){ localStorage.setItem(THEME_KEY, obj.theme); }
    applyTheme(); applyAccent(); renderSelectors(); buildLog(); buildTrends(); renderRoutinesList(); modal.alert('Import complete.');
  }catch(err){ modal.alert('Import failed: '+err.message); }
});

/* ===== Init ===== */
(function init(){
  if(!localStorage.getItem(THEME_KEY)){
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    localStorage.setItem(THEME_KEY, prefersDark?'dark':'light');
  }
  loadPrefs(); applyTheme(); applyAccent(); applySurface(); load();
  renderSelectors();
renderTrendsDaySelector();  // ⬅️ ensure dropdown has options on first load
buildLog();
buildTrends();
renderRoutinesList();
updateTimerDisplays();
updateTimerButtons();
const startPage = (state.routines && state.routines.length) ? 'logPage' : 'routinesPage';
showPage(startPage);


  $('openWizardBtn')?.addEventListener('click', ()=> openWizard(false));
})();

</script>

<!-- Service worker registration & update prompt -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    const reg = await navigator.serviceWorker.register('./sw.js').catch(()=>{});
    if (!reg) return;
    reg.addEventListener('updatefound', () => {
      const nw = reg.installing;
      nw && nw.addEventListener('statechange', () => {
        if (nw.state === 'installed' && navigator.serviceWorker.controller) {
         modal.confirm('Update available. Reload now?').then(ok => {
          if (ok) nw.postMessage({ action: 'skipWaiting' });
         });
        }

      });
    });
  });
}
</script>
<script>
(() => {
  // Safe palette reused
  const SAFE_COLORS = [
    [214, 97, 0],   // orange
    [0, 114, 178],  // blue
    [0, 158, 115],  // green
    [240, 228, 66], // yellow
    [204, 121, 167],// purple-pink
    [230, 159, 0],  // amber
    [86, 180, 233], // sky blue
    [213, 94, 0],   // rust
  ];

  const legendEl = document.getElementById('cal-legend');
  const gridEl   = document.getElementById('cal-grid');
  const labelEl  = document.getElementById('cal-month-label');
  const prevBtn  = document.getElementById('cal-prev');
  const nextBtn  = document.getElementById('cal-next');
  const popEl    = document.getElementById('cal-popup');
  const popCard  = popEl?.querySelector('.cal-pop-card');
  const popClose = document.getElementById('pop-close');
  if (!legendEl || !gridEl || !labelEl) return;

  const toISO=(y,m,d)=>`${y.toString().padStart(4,'0')}-${m.toString().padStart(2,'0')}`;
  const formatVolume = (v)=> (!v||v<=0)?'0':(v>=1000?(v/1000).toFixed(1)+'k':String(v));

  // Tiny helper: 2-letter abbrev (kept only for popup title if you want)
  function abbrevFromDayName(name=''){
    const t = (name || '').trim();
    if (!t) return '•';
    const a = t.charAt(0);
    const b = t.charAt(1) || '';
    return a.toLocaleUpperCase() + (b ? b.toLocaleLowerCase() : '');
  }

  // Build color map by unique day name (consistent across app)
  function buildDayColorMap(){
    const map = new Map();
    let i = 0;
    (state.routines || []).forEach(r=>{
      (r.days || []).forEach(d=>{
        const key = d.name.trim().toLowerCase();
        if (!map.has(key)){
          const color = SAFE_COLORS[i % SAFE_COLORS.length];
          map.set(key, { color, name: d.name });
          i++;
        }
      });
    });
    return map;
  }

  // Aggregate workouts by date and collect which day-types are actually used this month
  function getWorkoutsByDate(year, month, dayMap){
    const byDate = {};
    const usedKeys = new Set();

    (state.sessions || []).forEach(s=>{
      const iso = (s.workoutDate || s.dateISO || '').slice(0,10);
      if (!iso) return;
      const d = new Date(iso);
      if (isNaN(d)) return;
      if (d.getFullYear() !== year || (d.getMonth()+1) !== month) return;

      // find the day meta to get its name (type)
      const dayMeta = (state.routines || []).flatMap(r => r.days || [])
                         .find(dd => dd.id === s.dayId);
      const dayName = dayMeta?.name || 'Workout';
      const key = dayName.trim().toLowerCase();
      const info = dayMap.get(key);
      if (!info) return;

      usedKeys.add(key);

      if (!byDate[iso]){
        byDate[iso] = {
          // we keep a single primary type per day (most apps log one type/day)
          typeKey: key,
          title: dayName,
          colorRGB: info.color,
          totalSets: 0, totalReps: 0, totalVolume: 0,
          notes:[]
        };
      }

      const e = byDate[iso];
      const setsArr = Array.isArray(s.sets) ? s.sets : [];
      e.totalSets += setsArr.length;
      e.totalReps += setsArr.reduce((a,x)=>a+(+x.reps||0),0);
      e.totalVolume += +s.totalVolume || 0;
      if (s.note && s.note.trim()) e.notes.push(s.note.trim());
    });

    Object.keys(byDate).forEach(k => byDate[k].notes = byDate[k].notes.join('\n'));
    return { byDate, usedKeys };
  }

  // Render a tiny dot with the given color
  function dot(colorRGB){
    const [r,g,b]=colorRGB;
    const span = document.createElement('span');
    span.className = 'cal-dot';
    span.style.background = `rgb(${r}, ${g}, ${b})`;
    return span;
  }

  function makeBlank(){
    const el = document.createElement('div');
    el.className = 'cal-cell disabled';
    el.setAttribute('role','gridcell');
    el.setAttribute('aria-hidden','true');
    return el;
  }

  function makeEmptyCell(dayNum, iso){
    const el = document.createElement('div');
    el.className = 'cal-cell';
    el.setAttribute('role','gridcell');
    el.title = `${iso}: No workout`;

    const num = document.createElement('div');
    num.className = 'cal-num';
    num.textContent = String(dayNum);

    const dots = document.createElement('div');
    dots.className = 'cal-dots';

    el.appendChild(num);
    el.appendChild(dots);
    return el;
  }

  function makeWorkoutCell(dayNum, iso, e){
    const el = document.createElement('button');
    el.type='button';
    el.className = 'cal-cell';
    el.setAttribute('role','gridcell');
    el.title = `${iso}: ${e.title} — ${e.totalSets} sets, ${e.totalReps} reps, volume ${formatVolume(e.totalVolume)}`;

    const num = document.createElement('div');
    num.className = 'cal-num';
    num.textContent = String(dayNum);

    const dots = document.createElement('div');
    dots.className = 'cal-dots';
    dots.appendChild(dot(e.colorRGB)); // single dot; add more if you ever support multiple types in one day

    el.appendChild(num);
    el.appendChild(dots);

    // keep your popup behavior
    el.addEventListener('click',()=>openPopupAt(el,e));
    return el;
  }

  // Popup (kept as-is, just decoupled from old styles)
  function openPopupAt(anchorEl,data){
    if (!popEl || !popCard) return;
    document.getElementById('pop-title').textContent = data.title || 'Workout';
    document.getElementById('pop-sets-reps').textContent = `${data.totalSets} sets / ${data.totalReps} reps`;
    document.getElementById('pop-volume').textContent = formatVolume(data.totalVolume);
    document.getElementById('pop-notes').textContent = data.notes ? `Notes: ${data.notes}` : '—';

    const rect = anchorEl.getBoundingClientRect();
    popEl.hidden = false;
    const cardRect = popCard.getBoundingClientRect();
    const margin = 8;

    let top  = window.scrollY + rect.top - cardRect.height - margin;
    let left = window.scrollX + rect.left + (rect.width - cardRect.width) / 2;
    if (top < window.scrollY + 8) top = window.scrollY + rect.bottom + margin;
    left = Math.max(window.scrollX+8, Math.min(left, window.scrollX + window.innerWidth - cardRect.width - 8));

    popCard.style.top = `${top}px`;
    popCard.style.left = `${left}px`;
    popClose?.focus();

    document.addEventListener('click', onOutside, { capture:true });
    document.addEventListener('keydown', onEsc);
  }
  function onOutside(e){ if (!popCard.contains(e.target)) closePopup(); }
  function onEsc(e){ if (e.key === 'Escape') closePopup(); }
  function closePopup(){
    popEl.hidden = true;
    document.removeEventListener('click', onOutside, { capture:true });
    document.removeEventListener('keydown', onEsc);
  }
  popClose?.addEventListener('click', closePopup);

  // Legend: only show types actually used this month
  function renderLegend(dayMap, usedKeys){
    const used = [...usedKeys].filter(k => dayMap.has(k));
    if (!used.length) { legendEl.innerHTML = ''; return; }

    legendEl.innerHTML = used.map(k => {
      const info = dayMap.get(k);
      const [r,g,b] = info.color;
      return `
        <div class="legend-item">
          <span class="legend-dot" style="background: rgb(${r}, ${g}, ${b})"></span>
          <span class="legend-label">${info.name}</span>
        </div>
      `;
    }).join('');
  }

  // Month view state
  let view = (()=>{ const n = new Date(); return { y:n.getFullYear(), m:n.getMonth()+1 }; })();

  function render(){
    const dayMap = buildDayColorMap();
    labelEl.textContent = new Date(view.y, view.m-1, 1).toLocaleString(undefined,{month:'long', year:'numeric'});

    // Clear grid down to the DOW headers (first 7 items are the weekday names)
    while (gridEl.children.length > 7) gridEl.removeChild(gridEl.lastChild);

    const first = new Date(view.y, view.m-1, 1);
    const start = (first.getDay()+6)%7; // Monday-first
    const daysInMonth = new Date(view.y, view.m, 0).getDate();
    const { byDate, usedKeys } = getWorkoutsByDate(view.y, view.m, dayMap);

    for (let i=0; i<start; i++) gridEl.appendChild(makeBlank());
    for (let d=1; d<=daysInMonth; d++){
      const iso = toISO(view.y, view.m, d);
      const e = byDate[iso];
      gridEl.appendChild(e ? makeWorkoutCell(d, iso, e) : makeEmptyCell(d, iso));
    }

    renderLegend(dayMap, usedKeys);
  }

  prevBtn?.addEventListener('click', ()=>{ view.m--; if(view.m<1){view.m=12; view.y--;} render(); });
  nextBtn?.addEventListener('click', ()=>{ view.m++; if(view.m>12){view.m=1; view.y++;} render(); });

  render();
})();
</script>

<script>
  // Only runs when the app is inside Capacitor
  if (window.Capacitor && (Capacitor.getPlatform() === 'ios' || Capacitor.getPlatform() === 'android')) {
    // Apply safe area inset (Dynamic Island / status bar padding)
    document.documentElement.style.setProperty('--safe-top', 'env(safe-area-inset-top)');
  }
</script>



</body>
</html>
